<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeInvestMax</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        /* --- Global Styles --- */
        :root {
            --primary-color: #0a7afe;
            --secondary-color: #0c204d;
            --background-color: #f0f2f5;
            --text-color: #333;
            --light-text-color: #f8f9fa;
            --card-bg: #ffffff;
            --success-color: #28a745;
            --error-color: #dc3545;
            --pending-color: #ffc107;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh */
        }
        
        .app-container {
            max-width: 450px;
            margin: auto;
            background-color: var(--card-bg);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--background-color);
            transition: opacity 0.3s ease;
            padding-bottom: 85px; /* Space for nav bar */
        }
        
        .screen.active {
            display: block;
        }

        .screen.no-nav {
            padding-bottom: 20px;
        }
        
        /* --- Utility Classes --- */
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(10, 122, 254, 0.3);
        }
        
        .btn {
            display: inline-block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: var(--light-text-color);
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 {
            margin-top: 10px;
        }
        
        .mt-3 {
            margin-top: 20px;
        }
        
        .mt-4 {
            margin-top: 30px;
        }
        
        .link {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }
        
        /* --- Splash Screen --- */
        #splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .logo {
            width: 100px;
            height: 100px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .app-name {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-top: 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- Login & Registration --- */
        .auth-container {
            padding-top: 40px;
        }
        
        .auth-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--secondary-color);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .checkbox-group input {
            margin-right: 10px;
        }
        
        .extra-links {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        /* --- Home Screen --- */
        #home-screen {
            padding: 0;
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary-color), #0e4c92);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            position: relative;
            z-index: 10;
        }
        
        .profile-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #fff;
            cursor: pointer;
            object-fit: cover;
            border: 2px solid white;
        }
        
        .balance-info {
            text-align: center;
        }
        
        .balance-info span {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .balance-info h2 {
            font-size: 28px;
            margin: 0;
        }
        
        .deposit-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 500;
            border: 1px solid white;
        }
        
        .main-content {
            padding: 20px;
        }
        
        /* Banner Slider */
        .banner-slider {
            width: 100%;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            position: relative;
            background-color: #eee;
            min-height: 150px;
        }
        
        .slides-container {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        
        .slide {
            min-width: 100%;
        }
        
        .slide img {
            width: 100%;
            display: block;
            height: 150px;
            object-fit: cover;
        }
        
        /* Button Grid */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
        }
        
        .grid-icon {
            width: 50px;
            height: 50px;
            background-color: #eaf2ff;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .grid-item span {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        /* Product List */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .product-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            padding: 10px;
            position: relative;
        }

        .buy-product-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #eee;
        }
        
        .product-info {
            padding: 10px 0 0;
        }
        
        .product-info h4 {
            font-size: 15px;
            margin-bottom: 5px;
        }
        
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Navigation Bar */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 450px;
            height: 65px;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #888;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item i {
            font-size: 22px;
        }
        
        .nav-item span {
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* --- Profile Page --- */
        #profile-screen .profile-header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }
        
        #profile-screen .main-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            margin-bottom: 10px;
            object-fit: cover;
            cursor: pointer;
        }
        
        #profile-screen .info-group {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--box-shadow);
        }
        
        #profile-screen .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        #profile-screen .info-item:last-child {
            border-bottom: none;
        }
        
        .password-field {
            display: flex;
            align-items: center;
        }
        
        .password-field input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            width: 100px;
        }
        
        .password-field i {
            cursor: pointer;
            color: #888;
            margin-left: 10px;
        }
        
        /* Profile Gallery Popup */
        .gallery-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }
        
        .gallery-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .gallery-item {
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .gallery-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item.selected {
            border: 3px solid var(--primary-color);
        }
        
        /* --- Deposit Page --- */
        .payment-method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .method-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .method-card.selected {
            border-color: var(--primary-color);
            background-color: #eaf2ff;
            transform: scale(1.05);
        }
        
        .method-card img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        .method-card span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Deposit Notice */
        .deposit-notice {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        /* --- Popup/Modal --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .popup-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            animation: popup-appear 0.3s ease-out;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        @keyframes popup-appear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .popup-content h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .popup-content p {
            margin-bottom: 25px;
            color: #555;
        }
        
        /* New screen styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .back-btn {
            font-size: 20px;
            cursor: pointer;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .wallet-item, .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .wallet-item:last-child, .history-item:last-child {
            border-bottom: none;
        }
        
        /* Product Grid with 2 columns */
.product-grid-two-col {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.wallet-product-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 15px;
    box-shadow: var(--box-shadow);
    position: relative;
    transition: all 0.3s ease;
}

.wallet-product-card.sold {
    opacity: 0.7;
    background-color: #f8f9fa;
}

.wallet-product-card img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.wallet-product-info h4 {
    font-size: 15px;
    margin-bottom: 5px;
    color: var(--secondary-color);
}

.wallet-product-price {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.wallet-product-sell-price {
    font-size: 14px;
    color: var(--success-color);
    margin-bottom: 8px;
}

.wallet-product-date {
    font-size: 12px;
    color: #777;
    margin-bottom: 10px;
}

.product-status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.status-active {
    background-color: var(--success-color);
    color: white;
}

.status-sold {
    background-color: var(--secondary-color);
    color: white;
}

.sell-product-btn {
    width: 100%;
    padding: 8px;
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.sell-product-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.sell-product-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Product filter buttons */
.product-filter-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.product-filter-buttons .btn {
    width: auto;
    padding: 8px 15px;
    flex-shrink: 0;
}

.filter-active {
    background-color: var(--primary-color) !important;
    color: white !important;
}

/* Transaction history item styles */
.transaction-profit {
    color: var(--success-color);
    font-weight: 600;
}

.transaction-loss {
    color: var(--error-color);
    font-weight: 600;
}

/* Coin card styles */
.coin-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 15px;
    text-align: center;
    box-shadow: var(--box-shadow);
    position: relative;
    transition: all 0.3s ease;
}

.coin-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.coin-icon {
    width: 50px;
    height: 50px;
    margin: 0 auto 10px;
    border-radius: 50%;
    object-fit: cover;
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    font-weight: bold;
}

.coin-amount {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-color);
    margin: 5px 0;
}

.coin-value {
    font-size: 14px;
    color: #777;
}

/* Blurred effect for sold products */
.blurred-product {
    opacity: 0.7;
    filter: blur(1px);
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.blurred-product:hover {
    filter: blur(0);
    opacity: 1;
}

/* Product filter buttons */
.product-filter-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.product-filter-buttons .btn {
    width: auto;
    padding: 8px 15px;
    flex-shrink: 0;
}

.filter-active {
    background-color: var(--primary-color) !important;
    color: white !important;
}

/* Transaction Details Popup Styles */
.transaction-details-content {
    max-width: 500px;
    text-align: left;
    padding: 0;
    overflow: hidden;
}

.transaction-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    color: white;
}

.transaction-details-header h3 {
    margin: 0;
    color: white;
}

.close-transaction-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}

.transaction-details-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.transaction-detail-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.transaction-detail-item:last-child {
    border-bottom: none;
}

.transaction-detail-label {
    font-weight: 600;
    color: #555;
}

.transaction-detail-value {
    color: #333;
    text-align: right;
}

.transaction-profit {
    color: var(--success-color);
    font-weight: 600;
}

.transaction-loss {
    color: var(--error-color);
    font-weight: 600;
}

.transaction-amount-positive {
    color: var(--success-color);
    font-weight: 600;
}

.transaction-amount-negative {
    color: var(--error-color);
    font-weight: 600;
}

/* Clickable history items */
.history-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}
        
        .support-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .support-method:last-child {
            border-bottom: none;
        }
        
        .support-icon {
            width: 40px;
            height: 40px;
            background-color: #eaf2ff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .referral-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: var(--box-shadow);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 12px;
            color: #777;
        }
        
        .referral-list {
            margin-top: 20px;
        }
        
        /* Improved Referral List Styles */
.referral-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 17px;
    border-bottom: 1px solid #eee;
    background: white;
    border-radius: 12px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.referral-user-info {
    display: flex;
    align-items: center;
    flex: 1;
}

.referral-details {
    margin-left: 15px;
}

.referral-name {
    font-weight: 600;
    color: var(--secondary-color);
    margin-bottom: 4px;
}

.referral-date {
    font-size: 12px;
    color: #777;
}

.referral-commission {
    text-align: right;
    min-width: 80px;
}

.commission-amount {
    font-size: 18px;
    font-weight: 700;
    color: var(--success-color);
    margin-bottom: 2px;
}

.commission-label {
    font-size: 11px;
    color: #777;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.referral-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
        
        .referral-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .referral-item:last-child {
            border-bottom: none;
        }
        
        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .savings-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        .savings-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .coin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .coin-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            box-shadow: var(--box-shadow);
            cursor: pointer;
        }
        
        .coin-card.selected {
            border: 2px solid var(--primary-color);
            background-color: #eaf2ff;
        }
        
        .coin-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 10px;
            border-radius: 50%;
            object-fit: cover;
        }
        
      /* Loan Status Styles */
.loan-status {
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.loan-status.available {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.loan-status.not-available {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.loan-status h3 {
    margin-bottom: 10px;
    font-size: 20px;
}

.loan-status p {
    margin: 5px 0;
    font-size: 14px;
}

/* Loan Details Card */
.loan-details-card {
    background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin: 20px 0;
}

.loan-details-card h4 {
    color: var(--secondary-color);
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

/* Status Badges */
.savings-badge.pending {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
}

.savings-badge.approved {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
}

.savings-badge.rejected {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
}

.savings-badge.completed {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
}

/* Amount Range */
.amount-range {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
}

/* Custom Popup Styles */
.popup-content {
    text-align: left;
}

.popup-content .info-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.popup-content .info-item:last-child {
    border-bottom: none;
}

/* Loan Amount Input Styles */
#loan-amount {
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
}

#loan-amount:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 5px rgba(10, 122, 254, 0.3);
}

#loan-amount.error {
    border-color: var(--error-color);
}

.amount-range {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
    padding: 0 5px;
}

/* Loan Details Card Enhancements */
.loan-details-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.loan-details-card h4 {
    color: var(--secondary-color);
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
    font-size: 18px;
}

.loan-details-card .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.loan-details-card .info-item:last-child {
    border-bottom: none;
}

.loan-details-card .info-item span:first-child {
    color: #555;
    font-weight: 500;
}

.loan-details-card .info-item span:last-child {
    color: #333;
    font-weight: 600;
}

#total-payable {
    color: var(--primary-color) !important;
    font-size: 16px;
}

/* Popup Message Styles */
.popup-content strong {
    color: var(--primary-color);
}

.popup-content div {
    margin: 8px 0;
}

.popup-content .fa-info-circle {
    color: var(--primary-color);
    margin-right: 5px;
}

/* Payment Breakdown Styles */
.payment-breakdown {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border: 1px solid #e9ecef;
}

.payment-breakdown-title {
    color: var(--primary-color);
    text-align: center;
    margin-bottom: 15px;
    font-weight: 600;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
}

.payment-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 14px;
}

.payment-grid div {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.payment-grid div:nth-last-child(2),
.payment-grid div:last-child {
    border-bottom: none;
    font-weight: 600;
    color: var(--primary-color);
}

.payment-total {
    background: var(--primary-color);
    color: white;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    margin-top: 10px;
}

.late-fee {
    color: var(--error-color);
    font-weight: 600;
}

.payment-success {
    background: #d4edda;
    color: #155724;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    margin: 10px 0;
    border: 1px solid #c3e6cb;
}
        
        .lottery-card {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .lottery-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .lottery-card-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .lottery-prizes {
            margin: 15px 0;
            text-align: left;
        }

        .lottery-prize {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .lottery-prize i {
            margin-right: 10px;
            color: #ffc107;
        }

        .lottery-draw-date {
            font-size: 14px;
            margin-bottom: 15px;
        }

        .lottery-history-list {
            margin-top: 20px;
        }

        .lottery-ticket-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-info {
            font-family: monospace;
            font-size: 16px;
        }

        .ticket-user {
            font-size: 12px;
            color: #777;
        }
        
        /* Improved Lottery Tickets Styles */
.lottery-tickets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.lottery-ticket-card-new {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.lottery-ticket-card-new:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.ticket-number {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    color: var(--secondary-color);
    font-size: 16px;
}

.ticket-status {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-waiting {
    background-color: #fff3cd;
    color: #856404;
}

.status-won {
    background-color: #d4edda;
    color: #155724;
}

.status-lost {
    background-color: #f8d7da;
    color: #721c24;
}

.status-ended {
    background-color: #e2e3e5;
    color: #383d41;
}

.ticket-user-info {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 12px;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-details {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--secondary-color);
    margin-bottom: 2px;
}

.user-mobile {
    font-size: 12px;
    color: #6c757d;
}

.ticket-details {
    margin-bottom: 15px;
}

.detail-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    color: #555;
}

.detail-item i {
    width: 16px;
    margin-right: 8px;
    color: var(--primary-color);
}

.prize-info {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #856404;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: 700;
    margin-bottom: 15px;
    border: 1px solid #ffeaa7;
}

.ticket-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
}

.purchase-date {
    font-size: 11px;
    color: #6c757d;
}

.ticket-price {
    font-weight: 700;
    color: var(--primary-color);
}

.no-tickets-message {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.no-tickets-message i {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 15px;
}

.time-left {
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.countdown-text {
    color: var(--primary-color);
}

        /* Password Update Form */
        #password-update-form {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Withdraw Admin List */
        .admin-list {
            margin: 15px 0;
        }
        
        .admin-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .admin-item.selected {
            border-color: var(--primary-color);
            background-color: #eaf2ff;
        }
        
        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .admin-details {
            flex: 1;
        }
        
        .admin-name {
            font-weight: 600;
        }
        
        .admin-method {
            font-size: 14px;
            color: #777;
        }
        
        /* New styles for additional features */
        .amount-conversion {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .method-details-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }
        
        .method-details-display img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .transaction-history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .transaction-history-filters .btn {
            width: auto;
            padding: 8px 15px;
            flex-shrink: 0;
        }
        
        .kyc-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .kyc-verified {
            background-color: #d4edda;
            color: #155724;
        }
        
        .kyc-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .kyc-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .kyc-unverified {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .gift-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            position: relative;
        }

        .gift-card-occasion {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .gift-card-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .gift-card-code {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            letter-spacing: 2px;
            margin: 15px 0;
        }
        
        .gift-card-message {
            font-style: italic;
            margin: 10px 0;
        }
        
        .gift-card-date {
            font-size: 12px;
            color: #777;
            margin-top: 10px;
        }
        
        .gift-card-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            background: #eee;
            color: #555;
            display: inline-block;
            margin-top: 10px;
        }

        .gift-card-status.complete {
            background-color: var(--success-color);
            color: white;
        }
        
        /* Improved Savings Card Styles */
.savings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.savings-percentage {
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.savings-progress {
    margin: 15px 0;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #0e4c92);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-days {
    text-align: center;
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
}

.savings-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 15px 0;
}

.savings-item {
    display: flex;
    flex-direction: column;
}

.savings-label {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 3px;
}

.savings-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
}

.savings-value.profit {
    color: var(--success-color);
}

.savings-value.total {
    color: var(--primary-color);
    font-size: 16px;
}

.savings-countdown {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 15px;
    font-size: 14px;
    color: #6c757d;
}

.savings-countdown i {
    margin-right: 8px;
    color: var(--primary-color);
}

/* Savings Plans Container */
.savings-plans-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

/* Savings Plan Cards */
.savings-plan-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.savings-plan-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
}

.savings-plan-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), #0e4c92);
}

.plan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.plan-badge {
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    color: white;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.plan-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 16px;
}

.plan-title {
    color: var(--secondary-color);
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 15px;
    text-align: center;
}

.plan-return {
    text-align: center;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-radius: 12px;
}

.return-percentage {
    font-size: 32px;
    font-weight: 800;
    color: var(--success-color);
    line-height: 1;
}

.return-label {
    font-size: 14px;
    color: #388e3c;
    margin-top: 5px;
}

.plan-details {
    margin-bottom: 20px;
}

.detail-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-item i {
    width: 20px;
    color: var(--primary-color);
    margin-right: 12px;
}

.detail-item span {
    font-size: 14px;
    color: #555;
}

.plan-example {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.example-title {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 8px;
    font-weight: 600;
}

.example-item {
    font-size: 13px;
    color: var(--text-color);
    padding: 5px 0;
}

.example-item span {
    font-weight: 500;
}

.btn-plan-primary {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--primary-color), #0e4c92);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-plan-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(10, 122, 254, 0.3);
}

/* Amount Input Container */
.amount-input-container {
    display: none;
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #e9ecef;
}

.input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.input-header h4 {
    color: var(--secondary-color);
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
}

.close-btn:hover {
    color: var(--error-color);
}

.amount-input-wrapper {
    position: relative;
}

.currency-symbol {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-weight: 600;
}

.amount-input-wrapper .form-control {
    padding-left: 30px;
}

.amount-range {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
}

.return-calculation {
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.return-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
}

.return-item.final {
    border-top: 1px solid #e9ecef;
    margin-top: 8px;
    padding-top: 12px;
    font-weight: 600;
    color: var(--primary-color);
}

.btn-plan-confirm {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--success-color), #2e7d32);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-plan-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
}

.no-plans-message {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.no-plans-message i {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 15px;
}

        /* Send Money Page */
        .user-search {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .transfer-fee {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* P2P Trading */
        .p2p-tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .p2p-tab-buttons {
            display: flex;
            background-color: #eaf2ff;
            border-radius: var(--border-radius);
            padding: 5px;
        }
        .p2p-tab {
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary-color);
        }
        .p2p-tab.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--box-shadow);
        }
        .p2p-dropdown {
            position: relative;
        }
        .p2p-dropdown-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .p2p-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            z-index: 1;
        }
        .p2p-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .p2p-dropdown-content a:hover {background-color: #f1f1f1;}
        .p2p-dropdown:hover .p2p-dropdown-content {display: block;}

        .p2p-offer {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .p2p-offer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .p2p-user {
            display: flex;
            align-items: center;
            position: relative;
        }

        .online-status {
            position: absolute;
            bottom: 0;
            right: 35px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .online-status.online { background-color: #28a745; }
        .online-status.offline { background-color: #dc3545; }
        
        .p2p-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .p2p-rating {
            color: #ffc107;
        }
        
        .p2p-offer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .p2p-price {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .p2p-limits, .p2p-available {
            color: #777;
        }

        .p2p-payment-methods {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .p2p-payment-tag {
            background-color: #f0f2f5;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        /* File Upload Styles */
        .file-upload-container {
            margin-bottom: 15px;
        }
        
        .file-upload-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .file-upload-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            display: none;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        /* Loan Application Styles */
        .loan-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Transaction History Styles */
        .history-filter-active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

    </style>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
</head>
<body>
    <div class="app-container">
        <!-- 1. Splash Screen -->
        <div id="splash-screen" class="screen active no-nav">
            <div class="logo">SI</div>
            <div class="app-name">SafeInvestMax</div>
            <div class="loader"></div>
        </div>
        
        <!-- 2. Login Screen -->
        <div id="login-screen" class="screen no-nav">
            <div class="auth-container">
                <h2>Welcome!</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <div class="extra-links">
                        <a href="#" class="link" onclick="showScreen('forgot-password-screen')">Forgot Password?</a>
                        <a href="#" class="link" onclick="showScreen('register-screen')">Register</a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 3. Forgot Password Screen -->
        <div id="forgot-password-screen" class="screen no-nav">
            <div class="auth-container">
                <h2>Password Reset</h2>
                <p class="text-center" style="margin-bottom: 20px;">Enter your registered email, we will send a reset link.</p>
                <form id="forgot-password-form">
                    <div class="form-group">
                        <label for="forgot-email">Email</label>
                        <input type="email" id="forgot-email" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Link</button>
                    <div class="text-center mt-3">
                        <a href="#" class="link" onclick="showScreen('login-screen')">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 4. Registration Screen -->
        <div id="register-screen" class="screen no-nav">
            <div class="auth-container">
                <h2>Create New Account</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="reg-fullname">Full Name</label>
                        <input type="text" id="reg-fullname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-mobile">Mobile Number</label>
                        <input type="tel" id="reg-mobile" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-email">Email</label>
                        <input type="email" id="reg-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-password">Password (min 6 characters)</label>
                        <input type="password" id="reg-password" class="form-control" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="reg-confirm-password">Confirm Password</label>
                        <input type="password" id="reg-confirm-password" class="form-control" required>
                    </div>
                    <div class="form-group">
    <label for="reg-referral">Referral Code (Optional)</label>
    <input type="text" id="reg-referral" class="form-control" placeholder="Enter referral code if any">
</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms-conditions" required>
                        <label for="terms-conditions">I agree to the <a href="#" class="link" onclick="showScreen('terms-screen', 'register-screen')">Terms & Conditions</a></label>
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                    <div class="text-center mt-3">
                        <a href="#" class="link" onclick="showScreen('login-screen')">I already have an account</a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Terms Page -->
        <div id="terms-screen" class="screen no-nav">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="goBack()"></i>
                <h2 class="page-title">Terms & Conditions</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="card" style="padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
    <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">Terms & Conditions</h3>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
        <p style="margin-bottom: 20px; color: #555; line-height: 1.6;">Please read these terms and conditions carefully before using our services. By accessing or using our platform, you agree to be bound by these terms.</p>
        
        <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">1</div>
                <div style="color: #333; line-height: 1.5;">User must be at least 18 years old to use our services.</div>
            </div>
        </div>
        
        <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">2</div>
                <div style="color: #333; line-height: 1.5;">Account may be blocked for any illegal activity or violation of our policies.</div>
            </div>
        </div>
        
        <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">3</div>
                <div style="color: #333; line-height: 1.5;">We are committed to protecting user privacy and securing your personal information.</div>
            </div>
        </div>
        
        <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">4</div>
                <div style="color: #333; line-height: 1.5;">Investment market is risky, invest at your own responsibility after understanding all risks involved.</div>
            </div>
        </div>
        
        <div style="background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: flex-start;">
                <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">5</div>
                <div style="color: #333; line-height: 1.5;">We reserve the right to modify these terms at any time without prior notice.</div>
            </div>
        </div>
    </div>
</div>
        </div>
        
        <!-- 5-9. Home Screen -->
        <div id="home-screen" class="screen">
            <!-- Header -->
            <div class="header">
                <img id="home-profile-pic" src="https://i.pravatar.cc/150" alt="Profile" class="profile-pic" onclick="showScreen('profile-screen')">
                <div class="balance-info">
                    <span>Total Balance</span>
                    <h2 id="home-balance">$0.00</h2>
                </div>
                <a href="#" class="deposit-btn" onclick="showScreen('deposit-screen')">Deposit</a>
            </div>
            
            <div class="main-content">
                <!-- Banner Slider -->
                <div class="banner-slider" id="banner-slider">
                    <div class="slides-container" id="slides-container">
                        <!-- Banners will be loaded from Firebase -->
                    </div>
                </div>
                
                <!-- Button Grid -->
                <div class="button-grid">
                    <a href="#" class="grid-item" onclick="showScreen('referral-screen')"><div class="grid-icon"><i class="fa-solid fa-users"></i></div><span>Refer</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('savings-screen')"><div class="grid-icon"><i class="fa-solid fa-piggy-bank"></i></div><span>Savings</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('exchange-screen')"><div class="grid-icon"><i class="fa-solid fa-exchange-alt"></i></div><span>Exchange</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('loan-screen')"><div class="grid-icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><span>Loan</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('lottery-screen')"><div class="grid-icon"><i class="fa-solid fa-ticket"></i></div><span>Lottery</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('send-money-screen')"><div class="grid-icon"><i class="fa-solid fa-paper-plane"></i></div><span>Send Money</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('p2p-screen')"><div class="grid-icon"><i class="fa-solid fa-user-group"></i></div><span>P2P</span></a>
                    <a href="#" class="grid-item" onclick="showScreen('gift-card-screen')"><div class="grid-icon"><i class="fa-solid fa-gift"></i></div><span>Gift Card</span></a>
                </div>
                
                <!-- Product List -->
                <h3 class="section-title">Popular Products</h3>
                <div class="product-list" id="product-list">
                    <!-- Products will be loaded from Firebase -->
                </div>
            </div>
        </div>
        
        <!-- 10. Profile Screen -->
        <div id="profile-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">My Profile</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="profile-header">
                <img id="profile-pic" src="https://i.pravatar.cc/150" alt="Profile" class="main-profile-pic" onclick="showProfileGallery()">
                <h3 id="profile-name">John Doe</h3>
                <div id="kyc-status" class="kyc-status kyc-unverified">Unverified</div>
            </div>
            
            <div class="info-group">
                <div class="info-item">
                    <span>Email</span>
                    <span id="profile-email">user@example.com</span>
                </div>
                <div class="info-item">
                    <span>Mobile</span>
                    <span id="profile-mobile">+1234567890</span>
                </div>
                <div class="info-item">
                    <span>Password</span>
                    <div class="password-field">
                        <input type="password" value="********" disabled id="password-display">
                        <i class="fa-solid fa-eye" onclick="togglePasswordVisibility()"></i>
                    </div>
                </div>
                <div class="info-item">
                    <span>Referral Code</span>
                    <span id="referral-code">ABC123</span>
                </div>
                <div class="info-item">
                    <span>KYC Verification</span>
                    <a href="#" class="link" onclick="showScreen('kyc-screen')">Verify Now</a>
                </div>
                <div class="info-item">
                    <span>Terms & Conditions</span>
                    <a href="#" class="link" onclick="showScreen('terms-screen', 'profile-screen')">View</a>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            
            <!-- Password Update Form (Hidden by default) -->
            <div id="password-update-form">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" class="form-control">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-control">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control">
                </div>
                <button class="btn btn-primary" onclick="updatePassword()">Update Password</button>
                <button class="btn btn-secondary mt-2" onclick="cancelPasswordUpdate()">Cancel</button>
            </div>
        </div>
        
        <!-- Profile Gallery Popup -->
        <div class="gallery-popup" id="gallery-popup">
            <div class="gallery-container">
                <h3>Select Profile Picture</h3>
                <div class="gallery-grid">
                    <div class="gallery-item selected" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/150')">
                        <img src="https://i.pravatar.cc/150" alt="Profile 1">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/151')">
                        <img src="https://i.pravatar.cc/151" alt="Profile 2">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/152')">
                        <img src="https://i.pravatar.cc/152" alt="Profile 3">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/153')">
                        <img src="https://i.pravatar.cc/153" alt="Profile 4">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/154')">
                        <img src="https://i.pravatar.cc/154" alt="Profile 5">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/155')">
                        <img src="https://i.pravatar.cc/155" alt="Profile 6">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/156')">
                        <img src="https://i.pravatar.cc/156" alt="Profile 7">
                    </div>
                    <div class="gallery-item" onclick="selectGalleryImage(this, 'https://i.pravatar.cc/157')">
                        <img src="https://i.pravatar.cc/157" alt="Profile 8">
                    </div>
                </div>
                
                <button class="btn btn-primary mt-3" onclick="saveProfilePicture()">Save</button>
                <button class="btn btn-secondary mt-2" onclick="closeGallery()">Cancel</button>
            </div>
        </div>
        
        <!-- 11. Wallet Screen -->
        <div id="wallet-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">My Wallet</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="card">
                <div class="wallet-item">
                    <span>Total Balance</span>
                    <span id="wallet-balance">$0.00</span>
                </div>
                <div class="wallet-item">
                    <span>Available Balance</span>
                    <span id="available-balance">$0.00</span>
                </div>
                <div class="wallet-item">
                    <span>Locked Balance</span>
                    <span id="locked-balance">$0.00</span>
                </div>
            </div>
            
            <h3 class="section-title mt-4">My Products</h3>
<div class="product-filter-buttons">
    <button class="btn btn-primary history-filter-active" onclick="filterProducts('all')">All</button>
    <button class="btn btn-secondary" onclick="filterProducts('active')">Active</button>
    <button class="btn btn-secondary" onclick="filterProducts('sold')">Sold</button>
</div>
<div id="wallet-products" class="product-grid-two-col">
    <!-- User's purchased products will be loaded here -->
</div>

            <h3 class="section-title mt-4">My Coins</h3>
            <div class="coin-grid" id="wallet-coins">
                <!-- User's purchased coins will be loaded here -->
            </div>
        </div>
        
        <!-- 12. Deposit Screen -->
        <div id="deposit-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Deposit Funds</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="form-group">
                <label for="deposit-amount">Amount (USD)</label>
                <input type="number" id="deposit-amount" class="form-control" placeholder="Enter amount">
            </div>
            
            <h3 class="section-title">Select Payment Method</h3>
            <div class="payment-method-grid" id="payment-methods">
                <!-- Payment methods cards from admin will be loaded from Firebase -->
            </div>
            
            <div id="deposit-details-section" style="display: none;">
                <div id="method-details" class="method-details-display">
                    <!-- Selected method details will be shown here -->
                </div>
                
                <div id="deposit-input-fields">
                    <!-- Dynamic input fields based on admin settings will be shown here -->
                </div>
                
                <button class="btn btn-primary mt-3" id="deposit-button" onclick="processDeposit()">Submit Request</button>
            </div>
            
            <div class="deposit-notice">
                <p><strong>Note:</strong> Your deposit will be processed after verification. For any issue, contact support.</p>
            </div>
        </div>
        
        <!-- 13. Withdraw Screen (From Nav Bar) -->
        <div id="withdraw-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Withdraw Funds</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="form-group">
                <label for="withdraw-amount">Amount (USD)</label>
                <input type="number" id="withdraw-amount" class="form-control" placeholder="Enter amount">
            </div>
            
            <h3 class="section-title">Select Withdrawal Method</h3>
            <div class="admin-list" id="withdraw-admin-list">
                <!-- Withdrawal admin cards will be loaded from Firebase -->
            </div>
            
            <div id="withdrawal-details-section" style="display: none;">
                 <div id="withdraw-input-fields">
                    <!-- Dynamic input fields based on admin settings will be shown here -->
                </div>
                <button class="btn btn-primary mt-3" id="withdraw-button" onclick="processWithdrawal()">Submit Request</button>
            </div>
            
            <div class="deposit-notice">
                <p><strong>Note:</strong> Withdrawal processing time is 1-24 hours. Minimum withdrawal amount is $5.</p>
            </div>
        </div>
        
        <!-- 14. History Screen -->
        <div id="history-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Transaction History</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="transaction-history-filters">
    <button class="btn btn-primary history-filter-active" onclick="filterAllHistory('all')">All</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('deposit')">Deposits</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('withdraw')">Withdrawals</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('sent')">Sent</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('received')">Received</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('products')">Products</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('savings')">Savings</button>
    <button class="btn btn-secondary" onclick="filterAllHistory('loan')">Loan</button>
</div>
            
            <div id="history-list">
                <!-- History items will be loaded here -->
            </div>
        </div>
        
        <!-- 15. Support Screen -->
        <div id="support-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Support Center</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="card">
                <p>If you have any questions or need assistance, please contact our support team through one of the following methods:</p>
            </div>
            
            <div class="card">
                <div class="support-method" onclick="contactSupport('whatsapp')">
                    <div class="support-icon"><i class="fa-brands fa-whatsapp"></i></div>
                    <div>
                        <h4>WhatsApp</h4>
                        <p>+1 234 567 8900</p>
                    </div>
                </div>
                <div class="support-method" onclick="contactSupport('telegram')">
                    <div class="support-icon"><i class="fa-brands fa-telegram"></i></div>
                    <div>
                        <h4>Telegram</h4>
                        <p>@SafeInvestSupport</p>
                    </div>
                </div>
                <div class="support-method" onclick="contactSupport('email')">
                    <div class="support-icon"><i class="fa-solid fa-envelope"></i></div>
                    <div>
                        <h4>Email</h4>
                        <p>support@safinvestmax.com</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h4>Frequently Asked Questions</h4>
                <div id="faq-list">
                    <!-- FAQs will be loaded from Firebase -->
                </div>
            </div>
        </div>
        
        <!-- 16. Referral Screen -->
        <div id="referral-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Refer & Earn</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="referral-stats">
                <div class="stat-box">
                    <div class="stat-value" id="total-referrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="active-referrals">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="referral-earnings">$0</div>
                    <div class="stat-label">Earnings</div>
                </div>
            </div>
            
            <div class="card">
                <h4>Your Referral Code</h4>
                <div class="text-center">
                    <div class="gift-card-code" id="user-referral-code">ABC123DEF</div>
                    <button class="btn btn-secondary mt-2" onclick="copyReferralCode()">
                        <i class="fa-solid fa-copy"></i> Copy Code
                    </button>
                </div>
            </div>
            
            <h3 class="section-title">Your Referrals</h3>
            <div id="referral-list">
                <!-- Referral list will be loaded here -->
            </div>
        </div>
        
        <!-- 17. Savings Screen -->
        <div id="savings-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Savings Plans</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div id="savings-plans" class="savings-plans-container">
    <!-- Savings plans will be loaded from Firebase -->
</div>

            <h3 class="section-title mt-4">My Active Savings</h3>
            
<div id="active-savings-list">
    <div class="savings-card">
        <div class="savings-badge">Active</div>
        <div class="savings-header">
            <h3 style="color: var(--primary-color); margin-bottom: 5px;">30 Days Plan</h3>
            <div class="savings-percentage">45% Return</div>
        </div>
        
        <div class="savings-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 50%;"></div>
            </div>
            <div class="progress-days">15/30 Days Completed</div>
        </div>
        
        <div class="savings-grid">
            <div class="savings-item">
                <div class="savings-label">Invested Amount</div>
                <div class="savings-value">$100.00</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Start Date</div>
                <div class="savings-value">01 Sep 2025</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">End Date</div>
                <div class="savings-value">30 Sep 2025</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Duration</div>
                <div class="savings-value">30 Days</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Total Profit</div>
                <div class="savings-value profit">+ $45.00</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Daily Profit</div>
                <div class="savings-value">$1.50 / day</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Profit Added</div>
                <div class="savings-value">Daily</div>
            </div>
            <div class="savings-item">
                <div class="savings-label">Current Value</div>
                <div class="savings-value total">$122.50</div>
            </div>
        </div>
        
        <div class="savings-countdown">
            <i class="fa-solid fa-clock"></i>
            <span>15 days remaining</span>
        </div>
    </div>
</div>

<h3 class="section-title mt-4">Profit History</h3>
<div id="profit-history-list">
    <p class="text-center">Loading profit history...</p>
</div>
        </div>
        
        <!-- 18. Exchange Screen -->
        <div id="exchange-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Exchange Coins</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="form-group">
                <label for="from-coin">From</label>
                <select id="from-coin" class="form-control" onchange="calculateExchange()">
                    <!-- Options will be loaded from Firebase -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="from-amount">Amount</label>
                <input type="number" id="from-amount" class="form-control" placeholder="Enter amount" oninput="calculateExchange()">
            </div>
            
            <div class="text-center">
                <i class="fa-solid fa-exchange-alt" style="font-size: 24px; color: var(--primary-color);"></i>
            </div>
            
            <div class="form-group">
                <label for="to-coin">To</label>
                <select id="to-coin" class="form-control" onchange="calculateExchange()">
                    <!-- Options will be loaded from Firebase -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="to-amount">You Will Get</label>
                <input type="text" id="to-amount" class="form-control" readonly>
            </div>
            
            <div class="amount-conversion">
                <span>Exchange Rate: 1 <span id="from-coin-label">BTC</span> = <span id="exchange-rate">0</span> <span id="to-coin-label">USDT</span></span>
            </div>
            
            <button class="btn btn-primary" onclick="executeExchange()">Exchange Now</button>
        </div>
        
     <!-- 19. Loan Screen -->
<div id="loan-screen" class="screen">
    <div class="page-header">
        <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
        <h2 class="page-title">Loan Services</h2>
        <div style="width: 20px;"></div>
    </div>
    
    <div id="loan-eligibility-container">
        <!-- Loan eligibility status will be loaded here -->
    </div>

    <div id="loan-application-form" style="display: none;">
        <div class="card" style="padding: 20px; margin-bottom: 20px;">
            <h3 class="section-title" style="margin-bottom: 15px;">Apply for Loan</h3>
            
            <div class="form-group">
                <label for="loan-amount">Loan Amount ($)</label>
                <input type="number" id="loan-amount" class="form-control" placeholder="Enter amount" 
                       oninput="calculateLoanDetails()" min="0">
                <div class="amount-range">
                    <span id="min-loan-amount">Min: $0</span>
                    <span id="max-loan-amount">Max: $0</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="loan-duration">Loan Duration (Months)</label>
                <select id="loan-duration" class="form-control" onchange="calculateLoanDetails()">
                    <!-- Loan durations will be loaded dynamically -->
                </select>
            </div>
            
            <div class="loan-details-card" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <h4 style="margin-bottom: 15px; color: var(--secondary-color);">Loan Details</h4>
                
                <div class="info-item">
                    <span>Interest Rate</span>
                    <span id="loan-interest-rate">0%</span>
                </div>
                <div class="info-item">
                    <span>Monthly EMI</span>
                    <span id="monthly-emi">$0.00</span>
                </div>
                <div class="info-item">
                    <span>Total Interest</span>
                    <span id="total-interest">$0.00</span>
                </div>
                <div class="info-item">
                    <span>Total Payable</span>
                    <span id="total-payable" style="color: var(--primary-color); font-weight: 600;">$0.00</span>
                </div>
                <div class="info-item">
                    <span>Due Date</span>
                    <span id="due-date">-</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="applyForLoan()">Apply for Loan</button>
        </div>
    </div>
    
    <h3 class="section-title">My Active Loans</h3>
    <div id="active-loans">
        <!-- Active loans will be loaded here -->
    </div>
</div>
        
        <!-- 20. Lottery Screen -->
        <div id="lottery-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Lottery</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div id="lottery-container">
                <!-- Lottery items will be loaded from Firebase -->
            </div>

            <h3 class="section-title">My Lottery Tickets</h3>
            <div class="lottery-history-list" id="lottery-history-list">
                <p class="text-center">You have not purchased any tickets.</p>
            </div>
        </div>
        
        <!-- 21. Send Money Screen -->
        <div id="send-money-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Send Money</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="user-search">
                <div class="form-group">
                    <label for="receiver-search">Find User by Email</label>
                    <input type="text" id="receiver-search" class="form-control" placeholder="Enter user's email" oninput="searchUserByEmail(this.value)">
                </div>
            </div>
            
            <div id="receiver-info" style="display: none;">
                <div class="card">
                    <div class="info-item">
                        <span>Receiver</span>
                        <span id="receiver-name">-</span>
                    </div>
                    <div class="info-item">
                        <span>Email</span>
                        <span id="receiver-email">-</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="send-amount">Amount to Send ($)</label>
                <input type="number" id="send-amount" class="form-control" placeholder="Enter amount">
            </div>
            
            <div class="form-group">
                <label for="send-note">Note (Optional)</label>
                <input type="text" id="send-note" class="form-control" placeholder="Add a note">
            </div>
            
            <button class="btn btn-primary" id="send-money-btn" disabled onclick="confirmSendMoney()">Send Money</button>
        </div>
        
        <!-- 22. P2P Screen -->
        <div id="p2p-screen" class="screen">
            <div class="p2p-tabs">
                <div class="p2p-tab-buttons">
                    <div class="p2p-tab active" id="p2p-buy-tab" onclick="switchP2PTab('buy')">Buy</div>
                    <div class="p2p-tab" id="p2p-sell-tab" onclick="switchP2PTab('sell')">Sell</div>
                </div>
                <div class="p2p-dropdown">
                    <button class="p2p-dropdown-btn"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    <div class="p2p-dropdown-content">
                        <a href="#" onclick="showP2POfferForm('buy')">Create Buy Offer</a>
                        <a href="#" onclick="showP2POfferForm('sell')">Create Sell Offer</a>
                        <a href="#" onclick="showMyP2POffers()">My Offers</a>
                    </div>
                </div>
            </div>
            
            <div id="p2p-offers-container">
                <!-- P2P offers will be loaded here -->
            </div>
        </div>
        
        <!-- P2P Offer Form (Hidden by default) -->
        <div id="p2p-offer-form" style="display: none;" class="card mt-3">
            <h3 class="section-title" id="p2p-offer-form-title">Create P2P Offer</h3>
            <div class="form-group">
                <label for="p2p-offer-type">Offer Type</label>
                <select id="p2p-offer-type" class="form-control">
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            <div class="form-group">
                <label for="p2p-coin-type">Coin Type</label>
                <select id="p2p-coin-type" class="form-control">
                    <!-- Options will be loaded from Firebase -->
                </select>
            </div>
            <div class="form-group">
                <label for="p2p-price">Price (USD)</label>
                <input type="number" id="p2p-price" class="form-control" placeholder="Enter price per coin">
            </div>
            <div class="form-group">
                <label for="p2p-min-amount">Minimum Amount</label>
                <input type="number" id="p2p-min-amount" class="form-control" placeholder="Enter minimum amount">
            </div>
            <div class="form-group">
                <label for="p2p-max-amount">Maximum Amount</label>
                <input type="number" id="p2p-max-amount" class="form-control" placeholder="Enter maximum amount">
            </div>
            <div class="form-group">
                <label for="p2p-payment-methods">Payment Methods (comma separated)</label>
                <input type="text" id="p2p-payment-methods" class="form-control" placeholder="e.g. Bank Transfer, bKash, Nagad">
            </div>
            <button class="btn btn-primary" onclick="createP2POffer()">Create Offer</button>
            <button class="btn btn-secondary mt-2" onclick="cancelP2POfferForm()">Cancel</button>
        </div>
        
        <!-- 23. Gift Card Screen -->
        <div id="gift-card-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('home-screen')"></i>
                <h2 class="page-title">Gift Cards</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div class="text-center">
                <button class="btn btn-primary" onclick="showCreateGiftCard()">Create Gift Card</button>
                <button class="btn btn-secondary mt-2" onclick="showRedeemGiftCard()">Redeem Gift Card</button>
            </div>
            
            <div id="create-gift-card" style="display: none;" class="card mt-3">
                <h3 class="section-title">Create New Gift Card</h3>
                <div class="form-group">
                    <label for="gift-amount">Amount ($)</label>
                    <input type="number" id="gift-amount" class="form-control" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label for="gift-occasion">Occasion</label>
                    <select id="gift-occasion" class="form-control">
                        <option value="General">General Gift</option>
                        <option value="Birthday">🎂 Birthday</option>
                        <option value="Eid Mubarak">🌙 Eid Mubarak</option>
                        <option value="Wedding">💍 Wedding</option>
                        <option value="Anniversary">🎉 Anniversary</option>
                        <option value="Thank You">🙏 Thank You</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="gift-message">Message (Optional)</label>
                    <textarea id="gift-message" class="form-control" placeholder="Add a message" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="gift-usage-limit">Usage Limit</label>
                     <input type="number" id="gift-usage-limit" class="form-control" placeholder="How many users can redeem?" value="1">
                </div>
                
                <button class="btn btn-primary" onclick="createGiftCard()">Create Gift Card</button>
                <button class="btn btn-secondary mt-2" onclick="cancelCreateGiftCard()">Cancel</button>
            </div>
            
            <div id="redeem-gift-card" style="display: none;" class="card mt-3">
                 <h3 class="section-title">Redeem a Gift Card</h3>
                <div class="form-group">
                    <label for="gift-code">Gift Card Code</label>
                    <input type="text" id="gift-code" class="form-control" placeholder="Enter gift card code">
                </div>
                
                <button class="btn btn-primary" onclick="redeemGiftCard()">Redeem</button>
                <button class="btn btn-secondary mt-2" onclick="cancelRedeemGiftCard()">Cancel</button>
            </div>
            
            <h3 class="section-title mt-4">My Created Gift Cards</h3>
            <div id="gift-cards-list">
                <!-- Gift cards will be loaded here -->
            </div>
        </div>
        
        <!-- 24. KYC Screen -->
        <div id="kyc-screen" class="screen">
            <div class="page-header">
                <i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('profile-screen')"></i>
                <h2 class="page-title">KYC Verification</h2>
                <div style="width: 20px;"></div>
            </div>
            
            <div id="kyc-status-message">
                <!-- KYC status will be shown here -->
            </div>
            
            <div id="kyc-form">
                <div class="form-group">
                    <label for="kyc-fullname">Full Name (as per ID)</label>
                    <input type="text" id="kyc-fullname" class="form-control">
                </div>
                <div class="form-group">
                    <label for="kyc-dob">Date of Birth</label>
                    <input type="date" id="kyc-dob" class="form-control">
                </div>
                 <div class="form-group">
                    <label for="kyc-address-village">Village/Street</label>
                    <input type="text" id="kyc-address-village" class="form-control" placeholder="Enter Village/Street">
                </div>
                <div class="form-group">
                    <label for="kyc-address-post">Post Office</label>
                    <input type="text" id="kyc-address-post" class="form-control" placeholder="Enter Post Office">
                </div>
                <div class="form-group">
                    <label for="kyc-address-thana">Thana/Upazila</label>
                    <input type="text" id="kyc-address-thana" class="form-control" placeholder="Enter Thana/Upazila">
                </div>
                 <div class="form-group">
                    <label for="kyc-address-district">District</label>
                    <input type="text" id="kyc-address-district" class="form-control" placeholder="Enter District">
                </div>

                <div id="kyc-document-uploads">
                    <div class="form-group">
                        <label for="kyc-id-type">ID Type</label>
                        <select id="kyc-id-type" class="form-control">
                            <option value="nid">National ID</option>
                            <option value="passport">Passport</option>
                            <option value="driving_license">Driving License</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="kyc-id-number">ID Number</label>
                        <input type="text" id="kyc-id-number" class="form-control">
                    </div>
                    <div class="file-upload-container">
                        <label class="file-upload-label">ID Front Photo</label>
                        <input type="file" id="kyc-id-front" class="form-control" accept="image/*" onchange="previewImage(this, 'kyc-id-front-preview')">
                        <img id="kyc-id-front-preview" class="file-upload-preview">
                    </div>
                    <div class="file-upload-container">
                        <label class="file-upload-label">ID Back Photo</label>
                        <input type="file" id="kyc-id-back" class="form-control" accept="image/*" onchange="previewImage(this, 'kyc-id-back-preview')">
                        <img id="kyc-id-back-preview" class="file-upload-preview">
                    </div>
                    <div class="file-upload-container">
                        <label class="file-upload-label">Selfie with ID</label>
                        <input type="file" id="kyc-selfie" class="form-control" accept="image/*" onchange="previewImage(this, 'kyc-selfie-preview')">
                        <img id="kyc-selfie-preview" class="file-upload-preview">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="submitKYC()" id="kyc-submit-btn">
                    <span id="kyc-submit-text">Submit for Verification</span>
                    <span id="kyc-submit-spinner" class="spinner" style="display: none;"></span>
                </button>
            </div>
             <div id="kyc-details-locked" style="display:none;" class="card">
    <h4 style="color: var(--primary-color); margin-bottom: 20px; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #f0f2f5;">Your Verified KYC Information</h4>
    
    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #555;">Full Name</span>
                <span style="color: #333; font-weight: 500;" id="kyc-detail-fullname"></span>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #555;">Date of Birth</span>
                <span style="color: #333; font-weight: 500;" id="kyc-detail-dob"></span>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; flex-direction: column;">
                <span style="font-weight: 600; color: #555; margin-bottom: 5px;">Address</span>
                <span style="color: #333; font-weight: 500; line-height: 1.4; text-align: right;" id="kyc-detail-address"></span>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #555;">ID Type</span>
                <span style="color: #333; font-weight: 500;" id="kyc-detail-idtype"></span>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #555;">ID Number</span>
                <span style="color: #333; font-weight: 500;" id="kyc-detail-idnumber"></span>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="color: var(--success-color); font-weight: 600; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-circle-check" style="margin-right: 8px;"></i>
                <span>KYC Verification Completed</span>
            </div>
            <div style="font-size: 12px; color: #777; margin-top: 5px;">
                Verified on: <span id="kyc-verified-date"></span>
            </div>
        </div>
    </div>
</div>
        </div>
        
        <!-- Navigation Bar -->
        <div class="nav-bar" id="nav-bar" style="display: none;">
            <div class="nav-item active" data-screen="home-screen">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-screen="wallet-screen">
                <i class="fa-solid fa-wallet"></i>
                <span>Wallet</span>
            </div>
            <div class="nav-item" data-screen="history-screen">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <span>History</span>
            </div>
             <div class="nav-item" data-screen="withdraw-screen">
                <i class="fa-solid fa-money-bill-transfer"></i>
                <span>Withdraw</span>
            </div>
            <div class="nav-item" data-screen="support-screen">
                <i class="fa-solid fa-headset"></i>
                <span>Support</span>
            </div>
        </div>
        
        <!-- Popup Overlay -->
        <div class="popup-overlay" id="popup-overlay">
            <div class="popup-content">
                <h3 id="popup-title">Title</h3>
                <p id="popup-message">Message goes here</p>
                <div class="popup-buttons" id="popup-buttons">
                    <button class="btn btn-primary" onclick="closePopup()">OK</button>
                </div>
            </div>
        </div>
        
        <!-- Transaction Details Popup -->
<div class="popup-overlay" id="transaction-details-popup">
    <div class="popup-content transaction-details-content">
        <div class="transaction-details-header">
            <h3 id="transaction-details-title">Transaction Details</h3>
            <button class="close-transaction-btn" onclick="closeTransactionDetails()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="transaction-details-body" id="transaction-details-body">
            <!-- Transaction details will be loaded here -->
        </div>
    </div>
</div>
        
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2AiOk_fifsbafebm1KXN3at31oqIBudI",
            authDomain: "safeinvestmax-a9023.firebaseapp.com",
            databaseURL: "https://safeinvestmax-a9023-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "safeinvestmax-a9023",
            storageBucket: "safeinvestmax-a9023.firebasestorage.app",
            messagingSenderId: "571707257227",
            appId: "1:571707257227:web:1bdf4ed487127978acff8e",
            measurementId: "G-T17XRKVH1B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        const analytics = firebase.analytics();
    </script>

    <!-- App Script -->
    <script>
        // Global variables
        let currentUser = null;
        let userData = {};
        let selectedPaymentMethod = null;
        let selectedWithdrawAdmin = null;
        let selectedProfileImage = null;
        let exchangeRates = {};
        let appSettings = {};
        let previousScreen = 'splash-screen';
        let bannerInterval = null;
        let currentHistoryFilter = 'all';
        let kycFiles = {
            idFront: null,
            idBack: null,
            selfie: null
        };
        
        // Global variables for wallet and products
let currentProductFilter = 'all';
let adminSettings = {};

// Global variable for transaction details
let currentTransactionDetails = null;
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            setupEventListeners();
        });
        
        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadInitialData();
                } else {
                    currentUser = null;
                    userData = {};
                    showScreen('login-screen');
                }
            });
        }

        // Load initial app data (settings, user data, etc.)
        function loadInitialData() {
            const settingsRef = database.ref('settings');
            const userRef = database.ref('users/' + currentUser.uid);

            Promise.all([settingsRef.once('value'), userRef.once('value')])
            .then((snapshots) => {
                appSettings = snapshots[0].val() || {};
                userData = snapshots[1].val() || {};
                
                updateUIWithUserData();
                showScreen('home-screen');
                loadBanners();
                loadProducts();

            }).catch(error => {
                console.error("Error loading initial data:", error);
                showPopup('Error', 'Could not load app data. Please try again.');
            });
        }
        
        // Add this function after the loadInitialData() function
function cleanupCountdowns() {
    // Clear all countdown intervals to prevent memory leaks
    const countdownElements = document.querySelectorAll('.time-left');
    countdownElements.forEach(element => {
        if (element.dataset.intervalId) {
            clearInterval(parseInt(element.dataset.intervalId));
        }
    });
}
        
        function calculateSavingsReturn(planKey, interestRate, duration) {
    const amount = parseFloat(document.getElementById(`savings-amount-${planKey}`).value) || 0;
    
    if (amount > 0) {
        // Calculate total return based on the interest percentage
        const totalReturn = amount * (interestRate / 100);
        
        // Calculate daily profit (total return divided by duration in days)
        const dailyProfit = totalReturn / duration;
        
        // Calculate final amount after the term
        const finalAmount = amount + totalReturn;
        
        // Calculate daily percentage (total percentage divided by duration in days)
const dailyPercentage = (interestRate / duration).toFixed(3);
        
        document.getElementById(`total-return-${planKey}`).textContent = `$${totalReturn.toFixed(2)} (${interestRate}%)`;
        document.getElementById(`daily-profit-${planKey}`).textContent = `$${dailyProfit.toFixed(2)} (${dailyPercentage}%/day)`;
        document.getElementById(`final-amount-${planKey}`).textContent = `$${finalAmount.toFixed(2)}`;
    } else {
        document.getElementById(`total-return-${planKey}`).textContent = '$0.00 (0%)';
        document.getElementById(`daily-profit-${planKey}`).textContent = '$0.00 (0%/day)';
        document.getElementById(`final-amount-${planKey}`).textContent = '$0.00';
    }
}
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegistration);
            document.getElementById('forgot-password-form').addEventListener('submit', handlePasswordReset);
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const screenId = item.getAttribute('data-screen');
                    if (appSettings.disabledFeatures && appSettings.disabledFeatures[screenId]) {
                        showPopup('Notice', 'This feature is temporarily unavailable. Please try again later.');
                    } else {
                        showScreen(screenId);
                    }
                });
            });
        }
        
        // Show a specific screen
        function showScreen(screenId, backScreen = null) {
            const previousActiveScreen = document.querySelector('.screen.active');
            if (previousActiveScreen) {
                if (previousActiveScreen.id !== screenId) {
                    previousScreen = previousActiveScreen.id;
                }
                previousActiveScreen.classList.remove('active');
            }
            
            const newScreen = document.getElementById(screenId);
            newScreen.classList.add('active');
            if (backScreen) {
                newScreen.dataset.back = backScreen;
            }

            const navBar = document.getElementById('nav-bar');
            if (newScreen.classList.contains('no-nav')) {
                navBar.style.display = 'none';
            } else {
                navBar.style.display = 'flex';
                updateNavHighlighting(screenId);
            }
            
            loadScreenData(screenId);
        }
        
        // Go back to the previous screen
        function goBack() {
             const currentActiveScreen = document.querySelector('.screen.active');
             const backScreenId = currentActiveScreen.dataset.back || previousScreen || 'home-screen';
             showScreen(backScreenId);
        }
        
        // Load data specific to the screen being displayed
        function loadScreenData(screenId) {
    if (!currentUser) return;
    
    switch(screenId) {
        case 'home-screen':
            updateUIWithUserData();
            break;
        case 'wallet-screen':
            loadWalletData();
            break;
       case 'history-screen':
    filterAllHistory(currentHistoryFilter || 'all');
    break;
            filterAllHistory(currentHistoryFilter); // changed from loadTransactionHistory
            break;
        case 'referral-screen':
            loadReferralData();
            break;
        case 'savings-screen':
            loadSavingsPlans();
            loadProfitHistory();
            break;
        case 'loan-screen':
            loadLoanData();
            break;
        case 'lottery-screen':
            loadLotteryData();
            break;
        case 'gift-card-screen':
            loadGiftCards();
            break;
        case 'kyc-screen':
            loadKYCStatus();
            break;
        case 'deposit-screen':
            loadDepositMethods();
            break;
        case 'withdraw-screen':
            loadWithdrawalMethods();
            break;
        case 'p2p-screen':
            switchP2PTab('buy');
            break;
        case 'profile-screen':
            updateUIWithUserData();
            break;
        case 'exchange-screen':
            loadExchangeRates();
            break;
        case 'support-screen':
            loadFAQs();
            break;
        case 'admin-screen':
            loadAdminLoanPage();
            break;
    }
}
        
        // Load wallet data with products
function loadWalletData() {
    const totalBalance = (userData.balance || 0) + (userData.lockedBalance || 0);
    document.getElementById('wallet-balance').textContent = `$${totalBalance.toFixed(2)}`;
    document.getElementById('available-balance').textContent = `$${(userData.balance || 0).toFixed(2)}`;
    document.getElementById('locked-balance').textContent = `$${(userData.lockedBalance || 0).toFixed(2)}`;
    
    // Load admin settings
    database.ref('adminSettings').once('value').then(snapshot => {
        adminSettings = snapshot.val() || {};
        loadWalletProducts();
    }).catch(error => {
        console.error("Error loading admin settings:", error);
        loadWalletProducts();
    });
    
    loadWalletCoins();
}

// Load wallet products with filter
function loadWalletProducts() {
    const productsContainer = document.getElementById('wallet-products');
    productsContainer.innerHTML = '<p class="text-center">Loading products...</p>';
    
    if (!userData.products || Object.keys(userData.products).length === 0) {
        productsContainer.innerHTML = '<p class="text-center">No products purchased yet.</p>';
        return;
    }
    
    database.ref('products').once('value').then(productsSnapshot => {
        const allProducts = productsSnapshot.val();
        productsContainer.innerHTML = '';
        
        let hasProducts = false;
        
        Object.entries(userData.products).forEach(([key, purchase]) => {
            const product = allProducts[purchase.productId];
            if (!product) return;
            
            // Apply filter
            if (currentProductFilter === 'active' && purchase.status === 'sold') return;
            if (currentProductFilter === 'sold' && purchase.status !== 'sold') return;
            
            hasProducts = true;
            
            const isSold = purchase.status === 'sold';
            const purchaseDate = new Date(purchase.purchaseDate);
            const sellingPrice = purchase.sellingPrice || 
                                (purchase.price * (1 + (adminSettings.productSellProfitPercentage || 10) / 100));
            
            const productCard = document.createElement('div');
productCard.className = `wallet-product-card ${isSold ? 'sold blurred-product' : ''}`;
            productCard.innerHTML = `
                <div class="product-status-badge ${isSold ? 'status-sold' : 'status-active'}">
                    ${isSold ? 'Sold' : 'Active'}
                </div>
                <img src="${product.imageUrl || 'https://via.placeholder.com/200x120?text=Product'}" alt="${product.name}">
                <div class="wallet-product-info">
                    <h4>${product.name}</h4>
                    <div class="wallet-product-price">Purchased: $${purchase.price.toFixed(2)}</div>
                    ${isSold ? 
                        `<div class="wallet-product-sell-price">Sold: $${sellingPrice.toFixed(2)}</div>
                         <div class="wallet-product-profit">
                            ${sellingPrice > purchase.price ? 
                                `<span style="color: var(--success-color);">+$${(sellingPrice - purchase.price).toFixed(2)} (${((sellingPrice - purchase.price) / purchase.price * 100).toFixed(1)}%)</span>` : 
                                `<span style="color: var(--error-color);">-$${(purchase.price - sellingPrice).toFixed(2)} (${((purchase.price - sellingPrice) / purchase.price * 100).toFixed(1)}%)</span>`
                            }
                         </div>` : 
                        `<div class="wallet-product-sell-price">Sell: $${sellingPrice.toFixed(2)}</div>`
                    }
                    <div class="wallet-product-date">${purchaseDate.toLocaleDateString()}</div>
                    ${!isSold ? 
                        `<button class="sell-product-btn" onclick="sellProduct('${key}', '${product.name}', ${purchase.price}, ${sellingPrice})">
                            Sell Now
                         </button>` : 
                        ''
                    }
                </div>
            `;
            productsContainer.appendChild(productCard);
        });
        
        if (!hasProducts) {
            productsContainer.innerHTML = `<p class="text-center">No ${currentProductFilter} products found.</p>`;
        }
    });
}

// Load wallet coins
function loadWalletCoins() {
    const coinsContainer = document.getElementById('wallet-coins');
    coinsContainer.innerHTML = '';
    
    if (!userData.coins || Object.keys(userData.coins).length === 0) {
        coinsContainer.innerHTML = '<p class="text-center">No coins held yet.</p>';
        return;
    }
    
    database.ref('exchangeRates').once('value').then(ratesSnapshot => {
        const exchangeRates = ratesSnapshot.val() || {};
        const usdtRate = exchangeRates.USDT || 1;
        
        Object.entries(userData.coins).forEach(([coin, amount]) => {
            if (amount > 0) {
                const coinValue = coin === 'USDT' ? amount : amount * (exchangeRates[coin]?.USDT || 0);
                const coinCard = document.createElement('div');
                coinCard.className = 'coin-card';
                coinCard.innerHTML = `
                    <div class="coin-icon">${coin.substring(0, 3).toUpperCase()}</div>
                    <h4>${coin.toUpperCase()}</h4>
                    <div class="coin-amount">${amount.toFixed(8)}</div>
                    <div class="coin-value">$${(coinValue).toFixed(2)}</div>
                `;
                coinsContainer.appendChild(coinCard);
            }
        });
    });
}

// Filter products
function filterProducts(filter) {
    currentProductFilter = filter;
    
    // Update filter buttons
    document.querySelectorAll('.product-filter-buttons .btn').forEach(btn => {
        btn.classList.remove('filter-active');
    });
    event.target.classList.add('filter-active');
    
    loadWalletProducts();
}

// Sell product function
function sellProduct(productKey, productName, purchasePrice, sellingPrice) {
    const profit = sellingPrice - purchasePrice;
    const profitPercentage = (profit / purchasePrice * 100).toFixed(1);
    
    const confirmationMessage = `
        Are you sure you want to sell <strong>${productName}</strong>?
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>Purchase Price:</div>
                <div style="text-align: right;">$${purchasePrice.toFixed(2)}</div>
                
                <div>Selling Price:</div>
                <div style="text-align: right;">$${sellingPrice.toFixed(2)}</div>
                
                <div style="border-top: 1px solid #ddd; padding-top: 5px; font-weight: 600;">
                    ${profit >= 0 ? 'Profit:' : 'Loss:'}
                </div>
                <div style="text-align: right; border-top: 1px solid #ddd; padding-top: 5px; 
                            color: ${profit >= 0 ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: 600;">
                    ${profit >= 0 ? '+' : ''}$${Math.abs(profit).toFixed(2)} (${profitPercentage}%)
                </div>
            </div>
        </div>
    `;
    
    showConfirmationPopup(
        'Confirm Sale',
        confirmationMessage,
        () => processProductSale(productKey, productName, purchasePrice, sellingPrice, profit)
    );
}

// filterAllHistory ফাংশনটি সম্পূর্ণ রিপ্লেস করুন
function filterAllHistory(filter) {
    currentHistoryFilter = filter;
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '<p class="text-center">Loading transactions...</p>';
    
    // Update filter buttons
    document.querySelectorAll('.transaction-history-filters .btn').forEach(btn => {
        btn.classList.remove('history-filter-active');
    });
    event.target.classList.add('history-filter-active');
    
    database.ref('transactions').orderByChild('timestamp').once('value').then(snapshot => {
        historyList.innerHTML = '';
        
        if (!snapshot.exists()) {
            historyList.innerHTML = '<p class="text-center">No transactions found.</p>';
            return;
        }
        
        let hasTransactions = false;
        const transactions = [];
        
        snapshot.forEach(child => {
            const transaction = child.val();
            transaction.id = child.key;
            
            // Check if transaction belongs to current user
            if (transaction.userId === currentUser.uid || 
                (transaction.type === 'transfer' && 
                 (transaction.from === currentUser.uid || transaction.to === currentUser.uid))) {
                
                // Apply filter
                if (filter === 'all' || 
                    (filter === 'deposit' && transaction.type === 'deposit') ||
                    (filter === 'withdraw' && transaction.type === 'withdrawal') ||
                    (filter === 'sent' && transaction.type === 'transfer' && transaction.from === currentUser.uid) ||
                    (filter === 'received' && transaction.type === 'transfer' && transaction.to === currentUser.uid) ||
                    (filter === 'products' && (transaction.type === 'buy_product' || transaction.type === 'product_sale')) ||
                    (filter === 'savings' && transaction.type === 'profit') ||
                    (filter === 'loan' && (transaction.type === 'loan_application' || 
                                          transaction.type === 'loan_payment' || 
                                          transaction.type === 'loan_approved' || 
                                          transaction.type === 'loan_rejected'))) {
                    
                    transactions.push(transaction);
                    hasTransactions = true;
                }
            }
        });
        
        // Sort transactions by timestamp (newest first)
        transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (!hasTransactions) {
            historyList.innerHTML = `<p class="text-center">No ${filter} transactions found.</p>`;
            return;
        }
        
        transactions.forEach(transaction => {
            const transactionDate = new Date(transaction.timestamp);
            let amountClass = '';
            let amountPrefix = '';
            let icon = '';
            let title = '';
            
            switch(transaction.type) {
                case 'deposit':
                    amountClass = 'transaction-amount-positive';
                    amountPrefix = '+';
                    icon = 'fa-arrow-down';
                    title = 'Deposit';
                    break;
                case 'withdrawal':
                    amountClass = 'transaction-amount-negative';
                    amountPrefix = '-';
                    icon = 'fa-arrow-up';
                    title = 'Withdrawal';
                    break;
                case 'transfer':
                    if (transaction.from === currentUser.uid) {
                        amountClass = 'transaction-amount-negative';
                        amountPrefix = '-';
                        icon = 'fa-paper-plane';
                        title = 'Money Sent';
                    } else {
                        amountClass = 'transaction-amount-positive';
                        amountPrefix = '+';
                        icon = 'fa-envelope';
                        title = 'Money Received';
                    }
                    break;
                case 'buy_product':
                    amountClass = 'transaction-amount-negative';
                    amountPrefix = '-';
                    icon = 'fa-shopping-cart';
                    title = 'Product Purchase';
                    break;
                case 'product_sale':
                    amountClass = 'transaction-amount-positive';
                    amountPrefix = '+';
                    icon = 'fa-tag';
                    title = 'Product Sale';
                    break;
                case 'profit':
                    amountClass = 'transaction-amount-positive';
                    amountPrefix = '+';
                    icon = 'fa-chart-line';
                    title = 'Profit';
                    break;
                case 'loan_application':
                    amountClass = 'transaction-amount-negative';
                    amountPrefix = '-';
                    icon = 'fa-file-alt';
                    title = 'Loan Application';
                    break;
                case 'loan_payment':
                    amountClass = 'transaction-amount-negative';
                    amountPrefix = '-';
                    icon = 'fa-credit-card';
                    title = 'Loan Payment';
                    break;
                case 'loan_approved':
                    amountClass = 'transaction-amount-positive';
                    amountPrefix = '+';
                    icon = 'fa-check-circle';
                    title = 'Loan Approved';
                    break;
                case 'loan_rejected':
                    amountClass = '';
                    amountPrefix = '';
                    icon = 'fa-times-circle';
                    title = 'Loan Rejected';
                    break;
                default:
                    amountClass = '';
                    icon = 'fa-exchange-alt';
                    title = transaction.type.replace('_', ' ');
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.onclick = () => showTransactionDetails(transaction);
            
            historyItem.innerHTML = `
                <div>
                    <div style="font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: #777;">${transactionDate.toLocaleString()}</div>
                    ${transaction.note ? `<div style="font-size: 12px; color: #555;">${transaction.note}</div>` : ''}
                    ${transaction.productName ? `<div style="font-size: 12px; color: #555;">Product: ${transaction.productName}</div>` : ''}
                </div>
                <div class="${amountClass}" style="font-weight: 700;">
                    ${amountPrefix}$${transaction.amount ? transaction.amount.toFixed(2) : '0.00'}
                </div>
            `;
            
            historyList.appendChild(historyItem);
        });
    }).catch(error => {
        console.error("Error loading transaction history:", error);
        historyList.innerHTML = '<p class="text-center">Error loading transactions.</p>';
    });
}

// Process product sale
function processProductSale(productKey, productName, purchasePrice, sellingPrice) {
    // Update user balance
    const newBalance = (userData.balance || 0) + sellingPrice;
    
    // Update product status
    const updates = {};
    updates[`/users/${currentUser.uid}/balance`] = newBalance;
    updates[`/users/${currentUser.uid}/products/${productKey}/status`] = 'sold';
    updates[`/users/${currentUser.uid}/products/${productKey}/sellDate`] = new Date().toISOString();
    updates[`/users/${currentUser.uid}/products/${productKey}/sellingPrice`] = sellingPrice;
    
    // Get actual purchase price from user data for accurate profit calculation
    const actualPurchasePrice = userData.products[productKey].price;
    const actualProfit = sellingPrice - actualPurchasePrice;
    const profitPercentage = (actualProfit / actualPurchasePrice * 100).toFixed(1);
    
    // Update user's total profit/loss
    const currentProfit = userData.totalProfit || 0;
    const currentLoss = userData.totalLoss || 0;
    
    if (actualProfit >= 0) {
        updates[`/users/${currentUser.uid}/totalProfit`] = currentProfit + actualProfit;
    } else {
        updates[`/users/${currentUser.uid}/totalLoss`] = currentLoss + Math.abs(actualProfit);
    }
    
    database.ref().update(updates)
    .then(() => {
        // ট্রানজেকশন হিস্টোরিতে সংরক্ষণ
saveTransaction('product_sale', {
    productId: userData.products[productKey].productId,
    productKey: productKey,
    productName: productName,
    purchasePrice: actualPurchasePrice,
    sellingPrice: sellingPrice,
    profit: actualProfit,
    profitPercentage: profitPercentage,
    amount: sellingPrice
});
    })
    .then(() => {
        showPopup('Success', `You have successfully sold ${productName} for $${sellingPrice.toFixed(2)}.`);
        
        // Update local user data
        userData.balance = newBalance;
        userData.products[productKey].status = 'sold';
        userData.products[productKey].sellDate = new Date().toISOString();
        userData.products[productKey].sellingPrice = sellingPrice;
        
        if (actualProfit >= 0) {
            userData.totalProfit = (userData.totalProfit || 0) + actualProfit;
        } else {
            userData.totalLoss = (userData.totalLoss || 0) + Math.abs(actualProfit);
        }
        
        // Reload wallet products
        loadWalletProducts();
        updateUIWithUserData();
    })
    .catch(error => {
        console.error("Product sale error:", error);
        showPopup('Error', 'Failed to sell product. Please try again.');
    });
}

// Show transaction details
function showTransactionDetails(transaction) {
    currentTransactionDetails = transaction;
    const popup = document.getElementById('transaction-details-popup');
    const title = document.getElementById('transaction-details-title');
    const body = document.getElementById('transaction-details-body');
    
    // Set title based on transaction type
    switch(transaction.type) {
        case 'buy_product':
            title.textContent = 'Product Purchase Details';
            break;
        case 'product_sale':
            title.textContent = 'Product Sale Details';
            break;
        case 'deposit':
            title.textContent = 'Deposit Details';
            break;
        case 'withdrawal':
            title.textContent = 'Withdrawal Details';
            break;
        case 'transfer':
            title.textContent = transaction.from === currentUser.uid ? 'Money Sent Details' : 'Money Received Details';
            break;
        case 'profit':
            title.textContent = 'Savings Profit Details';
            break;
        case 'loan_application':
            title.textContent = 'Loan Application Details';
            break;
        case 'loan_payment':
            title.textContent = 'Loan Payment Details';
            break;
        case 'loan_approved':
            title.textContent = 'Loan Approval Details';
            break;
        case 'loan_rejected':
            title.textContent = 'Loan Rejection Details';
            break;
        default:
            title.textContent = 'Transaction Details';
    }
    
    // Clear previous content
    body.innerHTML = '<div class="text-center"><div class="spinner"></div> Loading details...</div>';
    
    // Show loading first
    popup.style.display = 'flex';
    
    // Load product details if it's a product transaction
    if (transaction.type === 'buy_product' || transaction.type === 'product_sale') {
        database.ref(`products/${transaction.productId}`).once('value').then(productSnapshot => {
            const product = productSnapshot.val();
            renderTransactionDetails(transaction, product);
        }).catch(error => {
            console.error("Error loading product details:", error);
            renderTransactionDetails(transaction, null);
        });
    } else {
        renderTransactionDetails(transaction, null);
    }
}

// Create transaction when loan is approved (Admin only)
function createLoanApprovedTransaction(loanId, loanData) {
    const transactionId = `loan_approved_${Date.now()}`;
    const transactionData = {
        type: 'loan_approved',
        loanId: loanId,
        amount: loanData.amount,
        duration: loanData.duration,
        interestRate: loanData.interestRate,
        monthlyEMI: loanData.monthlyEMI,
        totalPayable: loanData.totalPayable,
        timestamp: new Date().toISOString(),
        userId: loanData.userId
    };
    
    return database.ref(`transactions/${transactionId}`).set(transactionData);
}

// Create transaction when loan is rejected (Admin only)
function createLoanRejectedTransaction(loanId, loanData, reason) {
    const transactionId = `loan_rejected_${Date.now()}`;
    const transactionData = {
        type: 'loan_rejected',
        loanId: loanId,
        amount: loanData.amount,
        duration: loanData.duration,
        reason: reason,
        timestamp: new Date().toISOString(),
        userId: loanData.userId
    };
    
    return database.ref(`transactions/${transactionId}`).set(transactionData);
}

// Render transaction details
function renderTransactionDetails(transaction, product) {
    const body = document.getElementById('transaction-details-body');
    let html = '';
    
    const transactionDate = new Date(transaction.timestamp);
    
    switch(transaction.type) {
        case 'buy_product':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Product Name:</span>
                    <span class="transaction-detail-value">${product ? product.name : 'Unknown Product'}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Purchase Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Purchase Price:</span>
                    <span class="transaction-detail-value transaction-amount-negative">-$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Product Purchase</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction ID:</span>
                    <span class="transaction-detail-value">${transaction.productKey || 'N/A'}</span>
                </div>
            `;
            break;
            
        case 'product_sale':
            const profit = transaction.sellingPrice - transaction.purchasePrice;
            const profitPercentage = (profit / transaction.purchasePrice * 100).toFixed(1);
            
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Product Name:</span>
                    <span class="transaction-detail-value">${product ? product.name : 'Unknown Product'}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Sale Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Purchase Price:</span>
                    <span class="transaction-detail-value">$${transaction.purchasePrice.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Selling Price:</span>
                    <span class="transaction-detail-value transaction-amount-positive">+$${transaction.sellingPrice.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">${profit >= 0 ? 'Profit:' : 'Loss:'}</span>
                    <span class="transaction-detail-value ${profit >= 0 ? 'transaction-profit' : 'transaction-loss'}">
                        ${profit >= 0 ? '+' : '-'}$${Math.abs(profit).toFixed(2)} (${profitPercentage}%)
                    </span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Product Sale</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction ID:</span>
                    <span class="transaction-detail-value">${transaction.productKey || 'N/A'}</span>
                </div>
            `;
            break;
            
        case 'deposit':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Deposit Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Amount:</span>
                    <span class="transaction-detail-value transaction-amount-positive">+$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Deposit</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Status:</span>
                    <span class="transaction-detail-value">${transaction.status || 'Completed'}</span>
                </div>
            `;
            break;
            
        case 'withdrawal':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Withdrawal Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Amount:</span>
                    <span class="transaction-detail-value transaction-amount-negative">-$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Withdrawal</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Status:</span>
                    <span class="transaction-detail-value">${transaction.status || 'Completed'}</span>
                </div>
            `;
            break;
            
        case 'transfer':
            const isSent = transaction.from === currentUser.uid;
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">${isSent ? 'Receiver:' : 'Sender:'}</span>
                    <span class="transaction-detail-value">${isSent ? transaction.toEmail : transaction.fromEmail}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Amount:</span>
                    <span class="transaction-detail-value ${isSent ? 'transaction-amount-negative' : 'transaction-amount-positive'}">
                        ${isSent ? '-' : '+'}$${transaction.amount.toFixed(2)}
                    </span>
                </div>
                ${transaction.note ? `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Note:</span>
                    <span class="transaction-detail-value">${transaction.note}</span>
                </div>
                ` : ''}
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Money ${isSent ? 'Sent' : 'Received'}</span>
                </div>
            `;
            break;
            
        case 'profit':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Profit Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Amount:</span>
                    <span class="transaction-detail-value transaction-amount-positive">+$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Description:</span>
                    <span class="transaction-detail-value">${transaction.description || 'Savings Profit'}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Savings Profit</span>
                </div>
            `;
            break;
            
        case 'loan_application':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Application Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Loan Amount:</span>
                    <span class="transaction-detail-value">$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Duration:</span>
                    <span class="transaction-detail-value">${transaction.duration} Months</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Interest Rate:</span>
                    <span class="transaction-detail-value">${transaction.interestRate}% per month</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Monthly EMI:</span>
                    <span class="transaction-detail-value">$${transaction.monthlyEMI.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Total Payable:</span>
                    <span class="transaction-detail-value">$${transaction.totalPayable.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Status:</span>
                    <span class="transaction-detail-value">Pending Approval</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Loan Application</span>
                </div>
            `;
            break;

        case 'loan_payment':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Payment Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Payment Amount:</span>
                    <span class="transaction-detail-value transaction-amount-negative">-$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Principal Paid:</span>
                    <span class="transaction-detail-value">$${transaction.principalPaid.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Interest Paid:</span>
                    <span class="transaction-detail-value">$${transaction.interestPaid.toFixed(2)}</span>
                </div>
                ${transaction.penaltyPaid > 0 ? `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Penalty Paid:</span>
                    <span class="transaction-detail-value" style="color: var(--error-color);">$${transaction.penaltyPaid.toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Loan Payment</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Loan ID:</span>
                    <span class="transaction-detail-value">${transaction.loanId.substring(0, 8)}</span>
                </div>
            `;
            break;

        case 'loan_approved':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Approval Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Loan Amount:</span>
                    <span class="transaction-detail-value transaction-amount-positive">+$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Duration:</span>
                    <span class="transaction-detail-value">${transaction.duration} Months</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Interest Rate:</span>
                    <span class="transaction-detail-value">${transaction.interestRate}% per month</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Monthly EMI:</span>
                    <span class="transaction-detail-value">$${transaction.monthlyEMI.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Total Payable:</span>
                    <span class="transaction-detail-value">$${transaction.totalPayable.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Status:</span>
                    <span class="transaction-detail-value" style="color: var(--success-color);">Approved</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Loan Approved</span>
                </div>
            `;
            break;

        case 'loan_rejected':
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Rejection Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Loan Amount:</span>
                    <span class="transaction-detail-value">$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Duration:</span>
                    <span class="transaction-detail-value">${transaction.duration} Months</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Reason:</span>
                    <span class="transaction-detail-value">${transaction.reason || 'Not specified'}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Status:</span>
                    <span class="transaction-detail-value" style="color: var(--error-color);">Rejected</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">Loan Rejected</span>
                </div>
            `;
            break;
            
        default:
            html = `
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Date:</span>
                    <span class="transaction-detail-value">${transactionDate.toLocaleString()}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Amount:</span>
                    <span class="transaction-detail-value">$${transaction.amount.toFixed(2)}</span>
                </div>
                <div class="transaction-detail-item">
                    <span class="transaction-detail-label">Transaction Type:</span>
                    <span class="transaction-detail-value">${transaction.type}</span>
                </div>
            `;
    }
    
    body.innerHTML = html;
}



        function updateNavHighlighting(screenId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.screen === screenId);
            });
        }
        
        // --- Authentication ---
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
            .catch((error) => {
                let message = "An error occurred. Please try again.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        message = "Invalid email or password.";
                        break;
                    case 'auth/invalid-email':
                        message = "Please enter a valid email address.";
                        break;
                }
                showPopup('Login Failed', message);
            });
        }

        function handleRegistration(e) {
    e.preventDefault();
    const fullName = document.getElementById('reg-fullname').value;
    const mobile = document.getElementById('reg-mobile').value;
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;
    const referralCode = document.getElementById('reg-referral').value.trim(); // নতুন লাইন
            
            if (password !== confirmPassword) {
                showPopup('Error', 'Passwords do not match.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const newUser = userCredential.user;
                const newUser_Data = {
    uid: newUser.uid,
    fullName: fullName,
    mobile: mobile,
    email: email,
    balance: 0,
    lockedBalance: 0,
    referralCode: generateReferralCode(),
    referredBy: referralCode || null, // নতুন লাইন
    joinDate: new Date().toISOString(),
    kycStatus: 'unverified'
};
                return database.ref('users/' + newUser.uid).set(newUser_Data);
            })
            .then(() => {
                showPopup('Success', 'Registration successful!');
            })
            .catch((error) => {
                let message = "An error occurred. Please try again.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "An account with this email address already exists.";
                } else if (error.code === 'auth/weak-password') {
                    message = "The password is too weak. Please use at least 6 characters.";
                }
                showPopup('Registration Failed', message);
            });
        }

        function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            
            auth.sendPasswordResetEmail(email)
            .then(() => {
                showPopup('Success', 'A password reset link has been sent to your email.');
                showScreen('login-screen');
            })
            .catch((error) => {
                 let message = "An error occurred. Please try again.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    message = "No account found with this email address.";
                }
                showPopup('Error', message);
            });
        }

        function logout() {
            auth.signOut();
        }

        // --- UI Updates ---
        function updateUIWithUserData() {
            if (!userData || !currentUser) return;
            document.getElementById('profile-name').textContent = userData.fullName || 'User';
            document.getElementById('profile-email').textContent = userData.email || 'No email';
            document.getElementById('profile-mobile').textContent = userData.mobile || 'No mobile';
            document.getElementById('referral-code').textContent = userData.referralCode || 'N/A';
            document.getElementById('home-profile-pic').src = userData.profileImage || 'https://i.pravatar.cc/150';
            document.getElementById('profile-pic').src = userData.profileImage || 'https://i.pravatar.cc/150';
            
            const totalBalance = (userData.balance || 0).toFixed(2);
            document.getElementById('home-balance').textContent = `$${totalBalance}`;

            const kycStatus = userData.kycStatus || 'unverified';
            const kycBadge = document.getElementById('kyc-status');
            kycBadge.textContent = kycStatus.charAt(0).toUpperCase() + kycStatus.slice(1);
            kycBadge.className = 'kyc-status kyc-' + kycStatus;
        }

        // --- Home Screen ---
        function loadBanners() {
            database.ref('banners').orderByChild('active').equalTo(true).once('value').then(snapshot => {
                const slidesContainer = document.getElementById('slides-container');
                slidesContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const banners = [];
                    snapshot.forEach(child => {
                        banners.push(child.val());
                    });
                    
                    banners.forEach(banner => {
                        const slide = document.createElement('div');
                        slide.className = 'slide';
                        slide.innerHTML = `<img src="${banner.imageUrl}" alt="${banner.title || 'Banner'}">`;
                        slidesContainer.appendChild(slide);
                    });
                    
                    // Start banner rotation
                    startBannerRotation(banners.length);
                } else {
                    slidesContainer.innerHTML = '<div class="slide"><img src="https://via.placeholder.com/400x150?text=No+Banners" alt="No banners"></div>';
                }
            });
        }
        
        function startBannerRotation(bannerCount) {
            if (bannerCount <= 1) return;
            
            // Clear any existing interval
            if (bannerInterval) clearInterval(bannerInterval);
            
            let currentSlide = 0;
            const slidesContainer = document.getElementById('slides-container');
            
            bannerInterval = setInterval(() => {
                currentSlide = (currentSlide + 1) % bannerCount;
                slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
            }, 7000); // 7 seconds
        }
        
        function loadProducts() {
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const productList = document.getElementById('product-list');
                productList.innerHTML = '';
                if (products) {
                    Object.entries(products).forEach(([key, product]) => {
                        if (product.active) {
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card';
                            productCard.innerHTML = `
                                <div class="buy-product-icon" onclick="confirmPurchase('${key}', '${product.name}', ${product.price})"><i class="fa-solid fa-plus"></i></div>
                                <img src="${product.imageUrl || 'https://via.placeholder.com/200x120?text=Product'}" alt="${product.name}">
                                <div class="product-info">
                                    <h4>${product.name}</h4>
                                    <div class="product-price">$${product.price.toFixed(2)}</div>
                                </div>
                            `;
                            productList.appendChild(productCard);
                        }
                    });
                }
            });
        }
        
        function confirmPurchase(productId, productName, productPrice) {
            showConfirmationPopup(
                'Confirm Purchase', 
                `Are you sure you want to buy "${productName}" for $${productPrice.toFixed(2)}?`, 
                () => purchaseProduct(productId, productPrice)
            );
        }

        function purchaseProduct(productId, productPrice) {
    const currentBalance = userData.balance || 0;
    if (currentBalance < productPrice) {
        showPopup('Insufficient Funds', 'You do not have enough balance to purchase this product.');
        return;
    }
    
    const newBalance = currentBalance - productPrice;
    const userRef = database.ref('users/' + currentUser.uid);
    
    // Calculate selling price based on admin settings
    const profitPercentage = adminSettings.productSellProfitPercentage || 10;
    const sellingPrice = productPrice * (1 + profitPercentage / 100);
    
    userRef.update({ balance: newBalance })
    .then(() => {
        const purchaseData = {
            productId: productId,
            purchaseDate: new Date().toISOString(),
            price: productPrice,
            sellingPrice: sellingPrice,
            status: 'active'
        };
        return userRef.child('products').push(purchaseData);
    })
    .then((newProductRef) => {
       // ট্রানজেকশন হিস্টোরিতে সংরক্ষণ
saveTransaction('buy_product', {
    productId: productId,
    productKey: newProductRef.key,
    productName: product.name,
    amount: productPrice
});
    })
    .then(() => {
        showPopup('Success', 'Product purchased successfully!');
        userData.balance = newBalance;
        updateUIWithUserData();
    })
    .catch(error => {
        showPopup('Error', 'Failed to purchase product. Please try again.');
        console.error("Purchase error: ", error);
    });
}


        // --- Wallet Screen ---
        function loadWalletData() {
            const totalBalance = (userData.balance || 0) + (userData.lockedBalance || 0);
            document.getElementById('wallet-balance').textContent = `$${totalBalance.toFixed(2)}`;
            document.getElementById('available-balance').textContent = `$${(userData.balance || 0).toFixed(2)}`;
            document.getElementById('locked-balance').textContent = `$${(userData.lockedBalance || 0).toFixed(2)}`;
            
            const productsContainer = document.getElementById('wallet-products');
            productsContainer.innerHTML = '<p class="text-center">No products purchased yet.</p>';
            
            if (userData.products) {
                productsContainer.innerHTML = '';
                database.ref('products').once('value').then(productsSnapshot => {
                    const products = productsSnapshot.val();
                    Object.entries(userData.products).forEach(([key, purchase]) => {
                        const product = products[purchase.productId];
                        if (product) {
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card';
                            productCard.innerHTML = `
                                <img src="${product.imageUrl || 'https://via.placeholder.com/200x120?text=Product'}" alt="${product.name}">
                                <div class="product-info">
                                    <h4>${product.name}</h4>
                                    <div class="product-price">Purchased: $${purchase.price.toFixed(2)}</div>
                                    <div class="product-date">${new Date(purchase.purchaseDate).toLocaleDateString()}</div>
                                </div>
                            `;
                            productsContainer.appendChild(productCard);
                        }
                    });
                });
            }

            const coinsContainer = document.getElementById('wallet-coins');
            coinsContainer.innerHTML = '<p class="text-center">No coins held yet.</p>';
            
            if (userData.coins) {
                coinsContainer.innerHTML = '';
                Object.entries(userData.coins).forEach(([coin, amount]) => {
                    if (amount > 0) {
                        const coinCard = document.createElement('div');
                        coinCard.className = 'coin-card';
                        coinCard.innerHTML = `
                            <div class="coin-icon">${coin.substring(0, 3).toUpperCase()}</div>
                            <h4>${coin.toUpperCase()}</h4>
                            <div class="product-price">${amount.toFixed(8)}</div>
                        `;
                        coinsContainer.appendChild(coinCard);
                    }
                });
            }
        }
        
        // --- Deposit/Withdrawal ---
        function loadDepositMethods() {
            database.ref('depositMethods').orderByChild('active').equalTo(true).once('value').then(snapshot => {
                const methodsContainer = document.getElementById('payment-methods');
                methodsContainer.innerHTML = '';
                if(snapshot.exists()){
                    snapshot.forEach(childSnapshot => {
                        const method = childSnapshot.val();
                        const methodKey = childSnapshot.key;
                        const card = document.createElement('div');
                        card.className = 'method-card';
                        card.innerHTML = `
                            <img src="${method.iconUrl}" alt="${method.name}">
                            <span>${method.name}</span>
                        `;
                        card.onclick = () => selectDepositMethod(methodKey, method);
                        methodsContainer.appendChild(card);
                    });
                } else {
                     methodsContainer.innerHTML = '<p class="text-center">No deposit methods are available right now.</p>';
                }
            });
        }
        
        function selectDepositMethod(key, method) {
            selectedPaymentMethod = { key, ...method };
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            document.getElementById('deposit-details-section').style.display = 'block';
            
            const detailsDisplay = document.getElementById('method-details');
            detailsDisplay.innerHTML = `
                <h4>Payment Details</h4>
                <p><strong>Method:</strong> ${method.name}</p>
                <p><strong>Account:</strong> ${method.accountIdentifier}</p>
                <p><strong>Note:</strong> ${method.note || 'N/A'}</p>
            `;

            const inputFieldsContainer = document.getElementById('deposit-input-fields');
            inputFieldsContainer.innerHTML = '';
            method.requiredFields.forEach(field => {
                inputFieldsContainer.innerHTML += `
                    <div class="form-group">
                        <label for="deposit-${field.name}">${field.label}</label>
                        <input type="${field.type || 'text'}" id="deposit-${field.name}" class="form-control" placeholder="${field.placeholder}">
                    </div>
                `;
            });
        }
        
        function processDeposit() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    if (!amount || amount <= 0) {
        showPopup('Error', 'Please enter a valid amount.');
        return;
    }
    
    if (!selectedPaymentMethod) {
        showPopup('Error', 'Please select a payment method.');
        return;
    }
    
    // Collect additional fields
    const depositData = {
        amount: amount,
        method: selectedPaymentMethod.name,
        status: 'pending',
        timestamp: new Date().toISOString(),
        userId: currentUser.uid
    };
    
    selectedPaymentMethod.requiredFields.forEach(field => {
        const value = document.getElementById(`deposit-${field.name}`).value;
        depositData[field.name] = value;
    });
    
    // Save deposit request
    database.ref('depositRequests').push(depositData)
    .then(() => {
       // ট্রানজেকশন হিস্টোরিতে সংরক্ষণ
saveTransaction('deposit', {
    amount: amount,
    method: selectedPaymentMethod.name,
    status: 'pending'
});
    })
    .then(() => {
        showPopup('Success', 'Your deposit request has been submitted and is pending approval.');
        document.getElementById('deposit-amount').value = '';
        document.getElementById('deposit-details-section').style.display = 'none';
        document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
        selectedPaymentMethod = null;
    })
    .catch(error => {
        showPopup('Error', 'Failed to submit deposit request. Please try again.');
        console.error("Deposit error:", error);
    });
}

         function loadWithdrawalMethods() {
            database.ref('withdrawalMethods').orderByChild('active').equalTo(true).once('value').then(snapshot => {
                const listContainer = document.getElementById('withdraw-admin-list');
                listContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const method = childSnapshot.val();
                        const methodKey = childSnapshot.key;
                        const item = document.createElement('div');
                        item.className = 'admin-item';
                        item.innerHTML = `
                             <img src="${method.iconUrl}" alt="${method.name}" class="admin-avatar">
                             <div class="admin-details">
                                <div class="admin-name">${method.name}</div>
                             </div>
                        `;
                        item.onclick = () => selectWithdrawMethod(methodKey, method);
                        listContainer.appendChild(item);
                    });
                } else {
                    listContainer.innerHTML = '<p class="text-center">No withdrawal methods are available right now.</p>';
                }
            });
        }

        function selectWithdrawMethod(key, method) {
             selectedWithdrawAdmin = { key, ...method };
            document.querySelectorAll('.admin-item').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            document.getElementById('withdrawal-details-section').style.display = 'block';
            const inputFieldsContainer = document.getElementById('withdraw-input-fields');
            inputFieldsContainer.innerHTML = '';
             method.requiredFields.forEach(field => {
                inputFieldsContainer.innerHTML += `
                    <div class="form-group">
                        <label for="withdraw-${field.name}">${field.label}</label>
                        <input type="${field.type || 'text'}" id="withdraw-${field.name}" class="form-control" placeholder="${field.placeholder}">
                    </div>
                `;
            });
        }

        function processWithdrawal() {
    const amount = parseFloat(document.getElementById('withdraw-amount').value);
    if (!amount || amount <= 0) {
        showPopup('Error', 'Please enter a valid amount.');
        return;
    }
    
    if (amount < 5) {
        showPopup('Error', 'Minimum withdrawal amount is $5.');
        return;
    }
    
    if ((userData.balance || 0) < amount) {
        showPopup('Error', 'Insufficient balance.');
        return;
    }
    
    if (!selectedWithdrawAdmin) {
        showPopup('Error', 'Please select a withdrawal method.');
        return;
    }
    
    // Collect additional fields
    const withdrawalData = {
        amount: amount,
        method: selectedWithdrawAdmin.name,
        status: 'pending',
        timestamp: new Date().toISOString(),
        userId: currentUser.uid
    };
    
    selectedWithdrawAdmin.requiredFields.forEach(field => {
        const value = document.getElementById(`withdraw-${field.name}`).value;
        withdrawalData[field.name] = value;
    });
    
    // Update user balance and save withdrawal request
    const newBalance = (userData.balance || 0) - amount;
    
    const updates = {};
    updates[`/users/${currentUser.uid}/balance`] = newBalance;
    updates[`/withdrawalRequests/${Date.now()}`] = withdrawalData;
    
    database.ref().update(updates)
    .then(() => {
        // ট্রানজেকশন হিস্টোরিতে সংরক্ষণ
saveTransaction('withdrawal', {
    amount: amount,
    method: selectedWithdrawAdmin.name,
    status: 'pending'
});
    })
    .then(() => {
        showPopup('Success', 'Your withdrawal request has been submitted and is being processed.');
        document.getElementById('withdraw-amount').value = '';
        document.getElementById('withdrawal-details-section').style.display = 'none';
        document.querySelectorAll('.admin-item').forEach(c => c.classList.remove('selected'));
        selectedWithdrawAdmin = null;
        userData.balance = newBalance;
        updateUIWithUserData();
    })
    .catch(error => {
        showPopup('Error', 'Failed to process withdrawal. Please try again.');
        console.error("Withdrawal error:", error);
    });
}
        
        // --- Send Money ---
        let foundUser = null;
        function searchUserByEmail(email) {
            const receiverInfo = document.getElementById('receiver-info');
            const receiverName = document.getElementById('receiver-name');
            const receiverEmail = document.getElementById('receiver-email');
            const sendBtn = document.getElementById('send-money-btn');
            
            if (email.length < 5 || !email.includes('@')) {
                 receiverInfo.style.display = 'none';
                 sendBtn.disabled = true;
                 foundUser = null;
                 return;
            }

            database.ref('users').orderByChild('email').equalTo(email).once('value', snapshot => {
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userId = Object.keys(users)[0];
                    if (userId === currentUser.uid) {
                        receiverName.textContent = "Cannot send to yourself";
                        receiverEmail.textContent = email;
                        receiverInfo.style.display = 'block';
                        sendBtn.disabled = true;
                        foundUser = null;
                        return;
                    }
                    foundUser = { id: userId, ...users[userId] };
                    receiverName.textContent = foundUser.fullName;
                    receiverEmail.textContent = foundUser.email;
                    receiverInfo.style.display = 'block';
                    sendBtn.disabled = false;
                } else {
                    receiverName.textContent = "User not found";
                    receiverEmail.textContent = email;
                    receiverInfo.style.display = 'block';
                    sendBtn.disabled = true;
                    foundUser = null;
                }
            });
        }

        function confirmSendMoney() {
            if (!foundUser) {
                showPopup('Error', 'Please select a valid user to send money to.');
                return;
            }
            const amount = parseFloat(document.getElementById('send-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showPopup('Error', 'Please enter a valid amount.');
                return;
            }
            if ((userData.balance || 0) < amount) {
                showPopup('Error', 'Insufficient balance.');
                return;
            }
            
            showConfirmationPopup(
                'Confirm Transfer',
                `Are you sure you want to send $${amount.toFixed(2)} to ${foundUser.fullName}?`,
                () => executeSendMoney(amount)
            );
        }

        function executeSendMoney(amount) {
            const note = document.getElementById('send-note').value;
            const historyRef = database.ref('transactions');

            const senderNewBalance = (userData.balance || 0) - amount;
            const receiverNewBalance = (foundUser.balance || 0) + amount;

            const transactionId = historyRef.push().key;

            const updates = {};
            updates[`/users/${currentUser.uid}/balance`] = senderNewBalance;
            updates[`/users/${foundUser.id}/balance`] = receiverNewBalance;
            updates[`/transactions/${transactionId}`] = {
                from: currentUser.uid,
                fromEmail: userData.email,
                to: foundUser.id,
                toEmail: foundUser.email,
                amount: amount,
                note: note,
                timestamp: new Date().toISOString(),
                type: 'transfer'
            };

            database.ref().update(updates)
            .then(() => {
                showPopup('Success', `Successfully sent $${amount.toFixed(2)} to ${foundUser.fullName}.`);
                 document.getElementById('receiver-search').value = '';
                 document.getElementById('receiver-info').style.display = 'none';
                 document.getElementById('send-amount').value = '';
                 document.getElementById('send-note').value = '';
                 document.getElementById('send-money-btn').disabled = true;
                 foundUser = null;
                 userData.balance = senderNewBalance;
                 updateUIWithUserData();
            })
            .catch(error => {
                showPopup('Error', 'Transfer failed. Please try again.');
                console.error("Send money error:", error);
            });
        }

        // --- Gift Cards ---
        function createGiftCard() {
            const amount = parseFloat(document.getElementById('gift-amount').value);
            const usageLimit = parseInt(document.getElementById('gift-usage-limit').value);
            const occasion = document.getElementById('gift-occasion').value;

            if (isNaN(amount) || amount <= 0) {
                showPopup('Error', 'Please enter a valid amount.'); return;
            }
             if (isNaN(usageLimit) || usageLimit <= 0) {
                showPopup('Error', 'Please enter a valid usage limit.'); return;
            }
            if ((userData.balance || 0) < amount) {
                showPopup('Error', 'Insufficient balance to create this gift card.'); return;
            }
            
            const newBalance = (userData.balance || 0) - amount;
            const giftCardCode = 'GIFT-' + generateReferralCode();
            const giftCardData = {
                code: giftCardCode,
                amount: amount,
                occasion: occasion,
                message: document.getElementById('gift-message').value,
                createdBy: currentUser.uid,
                createdAt: new Date().toISOString(),
                usageLimit: usageLimit,
                redeemedCount: 0,
                status: 'active'
            };

            const updates = {};
            updates[`/users/${currentUser.uid}/balance`] = newBalance;
            updates[`/giftCards/${giftCardCode}`] = giftCardData;
            updates[`/users/${currentUser.uid}/createdGiftCards/${giftCardCode}`] = true;

            database.ref().update(updates)
            .then(() => {
                showPopup('Success', `Gift card created! Code: ${giftCardCode}`);
                userData.balance = newBalance;
                updateUIWithUserData();
                loadGiftCards();
                cancelCreateGiftCard();
            })
            .catch(error => {
                showPopup('Error', 'Failed to create gift card.');
            });
        }
        
        function loadGiftCards() {
            const listContainer = document.getElementById('gift-cards-list');
            listContainer.innerHTML = '';
            const userGiftCardRef = database.ref(`users/${currentUser.uid}/createdGiftCards`);
            
            userGiftCardRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    listContainer.innerHTML = '<p class="text-center">You have not created any gift cards.</p>';
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const cardCode = childSnapshot.key;
                    database.ref(`giftCards/${cardCode}`).once('value').then(cardSnap => {
                        const cardData = cardSnap.val();
                        if(!cardData) return;
                        const isComplete = cardData.redeemedCount >= cardData.usageLimit;
                        const cardElement = document.createElement('div');
                        cardElement.className = 'gift-card';
                        cardElement.innerHTML = `
                            ${cardData.occasion ? `<div class="gift-card-occasion">${cardData.occasion}</div>` : ''}
                            <div class="gift-card-amount">$${cardData.amount.toFixed(2)}</div>
                            <div class="gift-card-code">${cardData.code}</div>
                            <p class="gift-card-message">"${cardData.message || 'No message'}"</p>
                            <div class="gift-card-status ${isComplete ? 'complete' : ''}">
                                ${isComplete ? 'Completed' : 'Redeemed: ' + cardData.redeemedCount + ' / ' + cardData.usageLimit}
                            </div>
                            <div class="gift-card-date">Created: ${new Date(cardData.createdAt).toLocaleDateString()}</div>
                        `;
                        listContainer.appendChild(cardElement);
                    });
                });
            });
        }
        
        function redeemGiftCard() {
            const giftCode = document.getElementById('gift-code').value.trim();
            
            if (!giftCode) {
                showPopup('Error', 'Please enter a gift card code.');
                return;
            }
            
            database.ref(`giftCards/${giftCode}`).once('value').then(snapshot => {
                const giftCard = snapshot.val();
                
                if (!giftCard) {
                    showPopup('Error', 'Invalid gift card code.');
                    return;
                }
                
                if (giftCard.status !== 'active') {
                    showPopup('Error', 'This gift card is no longer active.');
                    return;
                }
                
                if (giftCard.redeemedCount >= giftCard.usageLimit) {
                    showPopup('Error', 'This gift card has reached its usage limit.');
                    return;
                }
                
                if (giftCard.createdBy === currentUser.uid) {
                    showPopup('Error', 'You cannot redeem your own gift card.');
                    return;
                }
                
                // Check if user has already redeemed this gift card
                database.ref(`users/${currentUser.uid}/redeemedGiftCards/${giftCode}`).once('value').then(redeemedSnap => {
                    if (redeemedSnap.exists()) {
                        showPopup('Error', 'You have already redeemed this gift card.');
                        return;
                    }
                    
                    // Process redemption
                    const newBalance = (userData.balance || 0) + giftCard.amount;
                    const newRedeemedCount = giftCard.redeemedCount + 1;
                    const isComplete = newRedeemedCount >= giftCard.usageLimit;
                    
                    const updates = {};
                    updates[`/users/${currentUser.uid}/balance`] = newBalance;
                    updates[`/users/${currentUser.uid}/redeemedGiftCards/${giftCode}`] = true;
                    updates[`/giftCards/${giftCode}/redeemedCount`] = newRedeemedCount;
                    
                    if (isComplete) {
                        updates[`/giftCards/${giftCode}/status`] = 'completed';
                    }
                    
                    database.ref().update(updates)
                    .then(() => {
                        showPopup('Success', `Successfully redeemed gift card! $${giftCard.amount.toFixed(2)} has been added to your balance.`);
                        userData.balance = newBalance;
                        updateUIWithUserData();
                        document.getElementById('gift-code').value = '';
                        cancelRedeemGiftCard();
                    })
                    .catch(error => {
                        showPopup('Error', 'Failed to redeem gift card. Please try again.');
                    });
                });
            });
        }
        
        // --- KYC ---
        function loadKYCStatus() {
            const kycStatus = userData.kycStatus || 'unverified';
            const kycData = userData.kycData;

            const kycStatusMessage = document.getElementById('kyc-status-message');
            const kycForm = document.getElementById('kyc-form');
            const kycDetailsLocked = document.getElementById('kyc-details-locked');
            
            kycStatusMessage.innerHTML = '';
            kycForm.style.display = 'none';
            kycDetailsLocked.style.display = 'none';

            if (kycStatus === 'verified') {
                kycStatusMessage.innerHTML = `<div class="card text-center"><h3 style="color: var(--success-color);">KYC Verified</h3><p>Your account is fully verified.</p></div>`;
                kycDetailsLocked.style.display = 'block';
                if (kycData) {
    // Populate KYC details if verified
    document.getElementById('kyc-detail-fullname').textContent = kycData.fullName || 'N/A';
    document.getElementById('kyc-detail-dob').textContent = kycData.dob || 'N/A';
    document.getElementById('kyc-detail-address').textContent = 
        `${kycData.village || ''}, ${kycData.post || ''}, ${kycData.thana || ''}, ${kycData.district || ''}`;
    document.getElementById('kyc-detail-idtype').textContent = kycData.idType ? kycData.idType.toUpperCase().replace('_', ' ') : 'N/A';
    document.getElementById('kyc-detail-idnumber').textContent = kycData.idNumber || 'N/A';
    document.getElementById('kyc-verified-date').textContent = new Date().toLocaleDateString();
}
            } else if (kycStatus === 'pending') {
                kycStatusMessage.innerHTML = `<div class="card text-center"><h3 style="color: var(--pending-color);">KYC Under Review</h3><p>Your documents are being reviewed.</p></div>`;
            } else if (kycStatus === 'rejected') {
                kycStatusMessage.innerHTML = `<div class="card text-center"><h3 style="color: var(--error-color);">KYC Rejected</h3><p>Your verification was rejected. Please resubmit.</p></div>`;
                kycForm.style.display = 'block';
            } else {
                kycStatusMessage.innerHTML = `<div class="card text-center"><h3>Verify Your Identity</h3><p>Please submit your information for verification.</p></div>`;
                kycForm.style.display = 'block';
            }

            document.getElementById('kyc-document-uploads').style.display = appSettings.kycRequiresDocuments ? 'block' : 'none';
        }

        function previewImage(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Store file for upload
                    if (input.id === 'kyc-id-front') kycFiles.idFront = file;
                    if (input.id === 'kyc-id-back') kycFiles.idBack = file;
                    if (input.id === 'kyc-selfie') kycFiles.selfie = file;
                };
                reader.readAsDataURL(file);
            }
        }

        function submitKYC() {
            const kycData = {
                fullName: document.getElementById('kyc-fullname').value,
                dob: document.getElementById('kyc-dob').value,
                village: document.getElementById('kyc-address-village').value,
                post: document.getElementById('kyc-address-post').value,
                thana: document.getElementById('kyc-address-thana').value,
                district: document.getElementById('kyc-address-district').value,
            };

            if (!kycData.fullName || !kycData.dob || !kycData.village || !kycData.thana) {
                 showPopup('Error', 'Please fill in all required fields.');
                 return;
            }
            
            // Show loading state
            document.getElementById('kyc-submit-text').style.display = 'none';
            document.getElementById('kyc-submit-spinner').style.display = 'inline-block';
            document.getElementById('kyc-submit-btn').disabled = true;
            
            if (appSettings.kycRequiresDocuments) {
                 kycData.idType = document.getElementById('kyc-id-type').value;
                 kycData.idNumber = document.getElementById('kyc-id-number').value;
                 
                 // Upload files to Firebase Storage
                 const uploadPromises = [];
                 
                 if (kycFiles.idFront) {
                     uploadPromises.push(uploadKYCFile(kycFiles.idFront, `kyc/${currentUser.uid}/id_front`));
                 }
                 
                 if (kycFiles.idBack) {
                     uploadPromises.push(uploadKYCFile(kycFiles.idBack, `kyc/${currentUser.uid}/id_back`));
                 }
                 
                 if (kycFiles.selfie) {
                     uploadPromises.push(uploadKYCFile(kycFiles.selfie, `kyc/${currentUser.uid}/selfie`));
                 }
                 
                 Promise.all(uploadPromises).then(fileUrls => {
                     if (fileUrls[0]) kycData.idFrontUrl = fileUrls[0];
                     if (fileUrls[1]) kycData.idBackUrl = fileUrls[1];
                     if (fileUrls[2]) kycData.selfieUrl = fileUrls[2];
                     
                     // Save KYC data to database
                     return saveKYCData(kycData);
                 }).catch(error => {
                     console.error("File upload error:", error);
                     showPopup('Error', 'Failed to upload documents. Please try again.');
                     resetKYCButton();
                 });
            } else {
                // Save KYC data without documents
                saveKYCData(kycData);
            }
        }
        
        function uploadKYCFile(file, path) {
            return new Promise((resolve, reject) => {
                const storageRef = storage.ref(`${path}_${Date.now()}`);
                const uploadTask = storageRef.put(file);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progress monitoring can be added here
                    },
                    (error) => {
                        reject(error);
                    },
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            resolve(downloadURL);
                        });
                    }
                );
            });
        }
        
        function saveKYCData(kycData) {
            database.ref('users/' + currentUser.uid).update({
                kycStatus: 'pending',
                kycData: kycData
            })
            .then(() => {
                showPopup('Success', 'Your KYC information has been submitted for review.');
                userData.kycStatus = 'pending';
                userData.kycData = kycData;
                resetKYCButton();
                loadKYCStatus();
            })
            .catch(error => {
                showPopup('Error', 'Failed to submit KYC information.');
                resetKYCButton();
            });
        }
        
        function resetKYCButton() {
            document.getElementById('kyc-submit-text').style.display = 'inline';
            document.getElementById('kyc-submit-spinner').style.display = 'none';
            document.getElementById('kyc-submit-btn').disabled = false;
        }
        
        // --- Lottery ---
        function loadLotteryData() {
            const container = document.getElementById('lottery-container');
            container.innerHTML = '';
             database.ref('lotteries').orderByChild('active').equalTo(true).once('value').then(snapshot => {
                 if (!snapshot.exists()) {
                     container.innerHTML = '<p class="text-center">No active lotteries at the moment.</p>';
                     return;
                 }
                 snapshot.forEach(child => {
                     const lottery = child.val();
                     const lotteryKey = child.key;
                     const card = document.createElement('div');
                     card.className = 'lottery-card';
                     card.innerHTML = `
                        ${lottery.imageUrl ? `<img src="${lottery.imageUrl}" class="lottery-card-image" alt="Lottery Image">` : ''}
                        <h3 class="lottery-card-title">${lottery.name}</h3>
                        <div class="lottery-prizes">
                            ${(Array.isArray(lottery.prizes) ? lottery.prizes : []).map(p => `<div class="lottery-prize"><i class="fa-solid fa-trophy"></i> <span>${p.rank}: ${p.prize}</span></div>`).join('')}
                        </div>
                        <div class="lottery-draw-date">Draw on: ${new Date(lottery.drawDate).toLocaleString()}</div>
                        <button class="btn btn-primary" onclick="buyLotteryTicket('${lotteryKey}', ${lottery.ticketPrice})">Buy Ticket ($${lottery.ticketPrice})</button>
                     `;
                     container.appendChild(card);
                 });
             });
             loadMyLotteryTickets();
        }

        function buyLotteryTicket(lotteryKey, price) {
            if ((userData.balance || 0) < price) {
                showPopup('Error', 'Insufficient balance to buy a lottery ticket.');
                return;
            }
            
            const newBalance = (userData.balance || 0) - price;
            const ticketNumber = `TKT-${Date.now()}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
            
            const ticketData = {
                lotteryId: lotteryKey,
                ticketNumber: ticketNumber,
                purchaseDate: new Date().toISOString(),
                price: price,
                status: 'waiting',
                userId: currentUser.uid
            };
            
            const updates = {};
            updates[`/users/${currentUser.uid}/balance`] = newBalance;
            updates[`/lotteryTickets/${ticketNumber}`] = ticketData;
            updates[`/users/${currentUser.uid}/lotteryTickets/${ticketNumber}`] = true;
            
            database.ref().update(updates)
            .then(() => {
                showPopup('Success', `You purchased a lottery ticket! Your ticket number is ${ticketNumber}.`);
                userData.balance = newBalance;
                updateUIWithUserData();
                loadMyLotteryTickets();
            })
            .catch(error => {
                showPopup('Error', 'Failed to purchase lottery ticket.');
            });
        }

// Real-time countdown function
function startLotteryCountdowns() {
    const countdownElements = document.querySelectorAll('.time-left');
    
    countdownElements.forEach(element => {
        const drawDate = new Date(element.dataset.drawdate);
        const countdownText = element.querySelector('.countdown-text');
        const ticketId = element.dataset.ticketid;
        
        const updateCountdown = () => {
            const now = new Date();
            const timeDiff = drawDate - now;
            
            if (timeDiff > 0) {
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                countdownText.textContent = `Time left: ${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
            } else {
                countdownText.textContent = '00d 00h 00m 00s';
                clearInterval(interval);
                
                // Update status to ended if draw time passed
                database.ref('lotteryTickets/' + ticketId).once('value').then(snapshot => {
                    const ticket = snapshot.val();
                    if (ticket && ticket.status === 'waiting') {
                        database.ref('lotteryTickets/' + ticketId).update({
                            status: 'ended'
                        });
                    }
                });
            }
        };
        
        // Update immediately and then every second
        updateCountdown();
        const interval = setInterval(updateCountdown, 1000);
        
        // Store interval reference for cleanup
        element.dataset.intervalId = interval;
    });
}



function loadMyLotteryTickets() {
    // Cleanup previous countdowns first
    cleanupCountdowns();
    
    const list = document.getElementById('lottery-history-list');
    list.innerHTML = '';
    
    database.ref('users/' + currentUser.uid + '/lotteryTickets').once('value').then(snapshot => {
        if (!snapshot.exists()) {
            list.innerHTML = '<div class="no-tickets-message"><i class="fa-solid fa-ticket"></i><p>You have not purchased any tickets yet</p></div>';
            return;
        }
        
        // Create container for grid layout
        const gridContainer = document.createElement('div');
        gridContainer.className = 'lottery-tickets-grid';
        
        snapshot.forEach(child => {
            const ticketId = child.key;
            database.ref('lotteryTickets/' + ticketId).once('value').then(ticketSnap => {
                const ticket = ticketSnap.val();
                if (!ticket) return;
                
                // Get user info
                database.ref('users/' + ticket.userId).once('value').then(userSnap => {
                    const user = userSnap.val();
                    if (!user) return;
                    
                    // Get lottery info
                    database.ref('lotteries/' + ticket.lotteryId).once('value').then(lotterySnap => {
                        const lottery = lotterySnap.val();
                        if (!lottery) return;
                        
                        const ticketCard = document.createElement('div');
                        ticketCard.className = 'lottery-ticket-card-new';
                        
                        let statusClass = '';
                        let statusText = '';
                        let prizeInfo = '';

                        const drawDate = new Date(lottery.drawDate);
                        const now = new Date();

                        // Check if ticket was purchased before draw date
                        const purchaseDate = new Date(ticket.purchaseDate);
                        const wasPurchasedBeforeDraw = purchaseDate < drawDate;

                        if (drawDate > now && wasPurchasedBeforeDraw) {
                            statusClass = 'status-waiting';
                            statusText = 'WAITING';
                        } else if (drawDate <= now && wasPurchasedBeforeDraw) {
                            // Draw has ended
                            if (ticket.status === 'won') {
                                statusClass = 'status-won';
                                statusText = 'WON';
                                prizeInfo = ticket.prize ? `<div class="prize-info">${ticket.prize}</div>` : '';
                            } else if (ticket.status === 'lost') {
                                statusClass = 'status-lost';
                                statusText = 'LOST';
                            } else {
                                statusClass = 'status-ended';
                                statusText = 'ENDED';
                            }
                        } else {
                            // Ticket was purchased after draw date
                            if (ticket.status === 'won' || ticket.status === 'approved') {
                                statusClass = 'status-won';
                                statusText = 'WON';
                                prizeInfo = ticket.prize ? `<div class="prize-info">${ticket.prize}</div>` : '';
                            } else {
                                statusClass = 'status-ended';
                                statusText = 'ENDED';
                            }
                        }
                        
                        // First create the ticket card without prizeInfo
                        ticketCard.innerHTML = `
                            <div class="ticket-header">
                                <div class="ticket-number">${ticket.ticketNumber}</div>
                                <div class="ticket-status ${statusClass}">${statusText}</div>
                            </div>
                            
                            <div class="ticket-user-info">
                                <div class="user-avatar">
                                    <img src="${user.profileImage || 'https://i.pravatar.cc/150'}" alt="User">
                                </div>
                                <div class="user-details">
                                    <div class="user-name">${user.fullName}</div>
                                    <div class="user-mobile">${user.mobile || 'No mobile'}</div>
                                </div>
                            </div>
                            
                            <div class="ticket-details">
                                <div class="detail-item">
                                    <i class="fa-solid fa-calendar"></i>
                                    <span>Draw: ${new Date(lottery.drawDate).toLocaleDateString()}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>Time: ${new Date(lottery.drawDate).toLocaleTimeString()}</span>
                                </div>
                                <div class="detail-item time-left" data-drawdate="${lottery.drawDate}" data-ticketid="${ticketId}">
                                    <i class="fa-solid fa-hourglass-half"></i>
                                    <span class="countdown-text">Time left: Calculating...</span>
                                </div>
                            </div>
                            
                            <div class="ticket-footer">
                                <div class="purchase-date">
                                    Purchased: ${new Date(ticket.purchaseDate).toLocaleDateString()}
                                </div>
                                <div class="ticket-price">
                                    $${ticket.price}
                                </div>
                            </div>
                        `;

                        // Then add prizeInfo if it exists
                        if (prizeInfo) {
                            const prizeElement = document.createElement('div');
                            prizeElement.innerHTML = prizeInfo;
                            // Insert prize info before the footer
                            const footer = ticketCard.querySelector('.ticket-footer');
                            ticketCard.insertBefore(prizeElement.firstChild, footer);
                        }

                        gridContainer.appendChild(ticketCard);
                        
                        // IMMEDIATELY start countdown for this ticket
                        startCountdownForTicket(ticketCard, lottery.drawDate, ticketId);
                    });
                });
            });
        });
        
        list.appendChild(gridContainer);
    });
}

// Start countdown for individual ticket
function startCountdownForTicket(ticketCard, drawDateString, ticketId) {
    const drawDate = new Date(drawDateString);
    const countdownElement = ticketCard.querySelector('.time-left');
    const countdownText = countdownElement.querySelector('.countdown-text');
    
    // Update immediately
    updateTicketCountdown(drawDate, countdownText, ticketId);
    
    // Update every second for real-time effect
    const interval = setInterval(() => {
        updateTicketCountdown(drawDate, countdownText, ticketId);
    }, 1000);
    
    // Store interval reference for cleanup
    countdownElement.dataset.intervalId = interval;
}

function updateTicketCountdown(drawDate, countdownText, ticketId) {
    const now = new Date();
    const timeDiff = drawDate - now;
    
    if (timeDiff > 0) {
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        countdownText.textContent = `Time left: ${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
    } else {
        countdownText.textContent = 'Time left: 00d 00h 00m 00s';
        
        // Check if we need to update status to ended
        database.ref('lotteryTickets/' + ticketId).once('value').then(snapshot => {
            const ticket = snapshot.val();
            if (ticket && ticket.status === 'waiting') {
                database.ref('lotteryTickets/' + ticketId).update({
                    status: 'ended'
                });
                
                // Update UI status if still on this page
                const statusElement = document.querySelector(`[data-ticketid="${ticketId}"]`).closest('.lottery-ticket-card-new').querySelector('.ticket-status');
                if (statusElement && statusElement.textContent === 'WAITING') {
                    statusElement.textContent = 'ENDED';
                    statusElement.className = 'ticket-status status-ended';
                }
            }
        });
    }
}

// Enhanced cleanup function
function cleanupCountdowns() {
    const countdownElements = document.querySelectorAll('.time-left');
    countdownElements.forEach(element => {
        if (element.dataset.intervalId) {
            clearInterval(parseInt(element.dataset.intervalId));
            delete element.dataset.intervalId;
        }
    });
}

// --- Transaction Management ---
function saveTransaction(type, data) {
    const transactionId = `${type}_${Date.now()}`;
    const transactionData = {
        type: type,
        ...data,
        timestamp: new Date().toISOString(),
        userId: currentUser.uid
    };
    
    return database.ref(`transactions/${transactionId}`).set(transactionData);
}
// --- End Transaction Management ---
        
        // --- Loan ---
    function loadLoanData() {
    const container = document.getElementById('loan-eligibility-container');
    const applicationForm = document.getElementById('loan-application-form');
    container.innerHTML = '';
    applicationForm.style.display = 'none';
    
    // Get admin settings for loan
    const minLoanAmount = appSettings.minLoanAmount || 50;
    const maxLoanPercentage = appSettings.loanPercentage || 0.5;
    
    // Check if user has active savings
    const hasActiveSavings = userData.savings && Object.values(userData.savings).some(s => s.status === 'active');
    
    if (!hasActiveSavings) {
        container.innerHTML = `
            <div class="loan-status not-available">
                <h3>Loan Not Available</h3>
                <p>You need to have an active savings plan to be eligible for a loan.</p>
            </div>
        `;
        return;
    }
    
    // Calculate maximum loan amount based on savings
    let totalSavings = 0;
    let maxLoanDays = 0;
    
    Object.values(userData.savings).forEach(saving => {
        if (saving.status === 'active') {
            totalSavings += saving.amount || 0;
            
            // Calculate remaining days for each savings plan
            const maturityDate = new Date(saving.maturityDate);
            const today = new Date();
            const remainingDays = Math.ceil((maturityDate - today) / (1000 * 60 * 60 * 24));
            
            if (remainingDays > maxLoanDays) {
                maxLoanDays = remainingDays;
            }
        }
    });
    
    // Calculate total approved loan amount
    let totalApprovedLoan = 0;
    let hasActiveLoans = false;
    if (userData.loans) {
        Object.values(userData.loans).forEach(loan => {
            if (loan.status === 'approved' || loan.status === 'active') {
                totalApprovedLoan += loan.amount || 0;
                hasActiveLoans = true;
            }
        });
    }
    
    const maxPossibleLoan = Math.min(
        totalSavings * maxLoanPercentage,
        appSettings.maxLoanAmount || 10000
    );
    
    const maxLoanAmount = maxPossibleLoan - totalApprovedLoan;
    const maxLoanDuration = Math.max(0, maxLoanDays - 10); // 10 days less than savings duration
    
    // Check if user meets minimum requirements
    if (maxLoanAmount < minLoanAmount || maxLoanDuration <= 0) {
        container.innerHTML = `
            <div class="loan-status not-available">
                <h3>Loan Not Available</h3>
                <p>Your savings plans do not meet the minimum loan requirements.</p>
                <p>Minimum loan amount: $${minLoanAmount.toFixed(2)}</p>
                <p>Your maximum available: $${maxLoanAmount.toFixed(2)}</p>
                ${hasActiveLoans ? `<p>You already have active loans totaling: $${totalApprovedLoan.toFixed(2)}</p>` : ''}
            </div>
        `;
    } else {
        // Show loan eligibility
        container.innerHTML = `
            <div class="loan-status available">
                <h3>Loan Available</h3>
                <p>You are eligible for a loan from $${minLoanAmount.toFixed(2)} to $${maxLoanAmount.toFixed(2)}</p>
                <p>Maximum duration: ${Math.floor(maxLoanDuration/30)} months</p>
                <p>Based on your active savings of $${totalSavings.toFixed(2)}</p>
                ${totalApprovedLoan > 0 ? `<p style="margin-top: 10px; font-size: 14px;">Already approved: $${totalApprovedLoan.toFixed(2)} (Remaining: $${maxLoanAmount.toFixed(2)})</p>` : ''}
            </div>
        `;
        
        applicationForm.style.display = 'block';
        
        // Set loan amount limits
        document.getElementById('min-loan-amount').textContent = `Min: $${minLoanAmount.toFixed(2)}`;
        document.getElementById('max-loan-amount').textContent = `Max: $${maxLoanAmount.toFixed(2)}`;
        document.getElementById('loan-amount').max = maxLoanAmount;
        document.getElementById('loan-amount').min = minLoanAmount;
        document.getElementById('loan-amount').value = minLoanAmount; // Set default to minimum
        
        // Load loan durations
        const durationSelect = document.getElementById('loan-duration');
        durationSelect.innerHTML = '';
        
        const maxMonths = Math.min(24, Math.floor(maxLoanDuration / 30));
        
        for (let i = 1; i <= maxMonths; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i} Month${i > 1 ? 's' : ''}`;
            durationSelect.appendChild(option);
        }
        
        // Calculate initial loan details
        calculateLoanDetails();
    }
    
    // Load active loans (always show active loans even if not eligible for new ones)
    loadActiveLoans();
}

function calculateLoanDetails() {
    const amountInput = document.getElementById('loan-amount');
    const amount = parseFloat(amountInput.value) || 0;
    const duration = parseInt(document.getElementById('loan-duration').value) || 1;
    const minLoanAmount = parseFloat(amountInput.min) || 0;
    const maxLoanAmount = parseFloat(amountInput.max) || 0;
    
    // Hide any previous error messages
    const existingError = document.getElementById('loan-amount-error');
    if (existingError) {
        existingError.remove();
    }
    
    // Validate amount and show error message
    if (amount > 0) {
        if (amount < minLoanAmount) {
            showAmountError(`Minimum loan amount is $${minLoanAmount.toFixed(2)}`);
            return;
        }
        
        if (amount > maxLoanAmount) {
            showAmountError(`Maximum loan amount is $${maxLoanAmount.toFixed(2)}`);
            return;
        }
    }
    
    // Get interest rate based on duration (monthly rate, not annual)
    const monthlyInterestRate = getInterestRateForDuration(duration);
    
    // Calculate total interest (monthly interest calculation)
    // Formula: Interest = Principal × Monthly Interest Rate × Duration
    const totalInterest = amount * (monthlyInterestRate / 100) * duration;
    const totalPayable = amount + totalInterest;
    const monthlyEMI = totalPayable / duration;
    
    // Calculate due date
    const dueDate = new Date();
    dueDate.setMonth(dueDate.getMonth() + duration);
    
    document.getElementById('loan-interest-rate').textContent = `${monthlyInterestRate}% per month`;
    document.getElementById('monthly-emi').textContent = `$${monthlyEMI.toFixed(2)}`;
    document.getElementById('total-interest').textContent = `$${totalInterest.toFixed(2)}`;
    document.getElementById('total-payable').textContent = `$${totalPayable.toFixed(2)}`;
    document.getElementById('due-date').textContent = dueDate.toLocaleDateString();
    
    // Debug log (you can remove this later)
    console.log('Loan Calculation:', {
        amount: amount,
        monthlyInterestRate: monthlyInterestRate,
        duration: duration,
        totalInterest: totalInterest,
        totalPayable: totalPayable,
        monthlyEMI: monthlyEMI
    });
}

function showAmountError(message) {
    // Remove any existing error
    const existingError = document.getElementById('loan-amount-error');
    if (existingError) {
        existingError.remove();
    }
    
    // Create and show new error message
    const errorDiv = document.createElement('div');
    errorDiv.id = 'loan-amount-error';
    errorDiv.style.color = 'var(--error-color)';
    errorDiv.style.fontSize = '12px';
    errorDiv.style.marginTop = '5px';
    errorDiv.style.padding = '5px';
    errorDiv.style.backgroundColor = '#f8d7da';
    errorDiv.style.borderRadius = '4px';
    errorDiv.style.border = '1px solid #f5c6cb';
    errorDiv.textContent = message;
    
    document.getElementById('loan-amount').parentNode.appendChild(errorDiv);
}

function getInterestRateForDuration(duration) {
    if (!appSettings.loanInterestRates) {
        return 10; // Default interest rate
    }
    
    // Find the appropriate interest rate for the duration
    const rates = appSettings.loanInterestRates;
    let selectedRate = rates[0]?.rate || 10;
    
    // Sort rates by months in descending order
    const sortedRates = rates.sort((a, b) => b.months - a.months);
    
    for (const rate of sortedRates) {
        if (duration >= rate.months) {
            selectedRate = rate.rate;
            break;
        }
    }
    
    return selectedRate;
}

function applyForLoan() {
    const amount = parseFloat(document.getElementById('loan-amount').value);
    const duration = parseInt(document.getElementById('loan-duration').value);
    const minLoanAmount = parseFloat(document.getElementById('loan-amount').min) || 0;
    const maxLoanAmount = parseFloat(document.getElementById('loan-amount').max) || 0;
    
    if (isNaN(amount) || amount <= 0) {
        showPopup('Error', 'Please enter a valid loan amount.');
        return;
    }
    
    if (amount < minLoanAmount) {
        showPopup('Error', `Loan amount cannot be less than $${minLoanAmount.toFixed(2)}.`);
        return;
    }
    
    if (amount > maxLoanAmount) {
        showPopup('Error', `Loan amount cannot exceed $${maxLoanAmount.toFixed(2)}.`);
        return;
    }
    
    // Calculate loan details with monthly interest
    const monthlyInterestRate = getInterestRateForDuration(duration);
    const totalInterest = amount * (monthlyInterestRate / 100) * duration;
    const totalPayable = amount + totalInterest;
    const monthlyEMI = totalPayable / duration;
    
    const dueDate = new Date();
    dueDate.setMonth(dueDate.getMonth() + duration);
    
    const confirmationMessage = `
        Are you sure you want to apply for a loan of <strong>$${amount.toFixed(2)}</strong> for <strong>${duration} month(s)</strong>?
        
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong style="color: var(--primary-color);">Loan Details:</strong><br>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                <div>Principal Amount:</div>
                <div style="text-align: right;">$${amount.toFixed(2)}</div>
                
                <div>Interest Rate:</div>
                <div style="text-align: right;">${monthlyInterestRate}% per month</div>
                
                <div>Loan Duration:</div>
                <div style="text-align: right;">${duration} month(s)</div>
                
                <div>Total Interest:</div>
                <div style="text-align: right;">$${totalInterest.toFixed(2)}</div>
                
                <div>Monthly EMI:</div>
                <div style="text-align: right;">$${monthlyEMI.toFixed(2)}</div>
                
                <div>Total Payable:</div>
                <div style="text-align: right; color: var(--primary-color); font-weight: 600;">$${totalPayable.toFixed(2)}</div>
                
                <div>Due Date:</div>
                <div style="text-align: right;">${dueDate.toLocaleDateString()}</div>
            </div>
        </div>
        
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <i class="fa-solid fa-info-circle"></i> Interest is calculated monthly for the loan duration.
        </div>
    `;
    
    showConfirmationPopup(
        'Confirm Loan Application',
        confirmationMessage,
        () => processLoanApplication(amount, duration, monthlyInterestRate, monthlyEMI, totalPayable, dueDate)
    );
}

function processLoanApplication(amount, duration, interestRate, emi, totalPayable, dueDate) {
    // Calculate daily interest rate for future calculations
    const dailyInterestRate = (interestRate / 100) / 365;
    
    const loanData = {
        amount: amount,
        duration: duration,
        interestRate: interestRate,
        dailyInterestRate: dailyInterestRate,
        monthlyEMI: emi,
        totalPayable: totalPayable,
        remainingAmount: totalPayable,
        remainingPrincipal: amount,
        appliedDate: new Date().toISOString(),
        dueDate: dueDate.toISOString(),
        status: 'pending',
        lastPaymentDate: null,
        nextPaymentDate: getNextPaymentDate(new Date(), 1), // First payment after 1 month
        payments: [],
        penaltyAmount: 0,
        totalPenaltyPaid: 0
    };
    
    database.ref(`users/${currentUser.uid}/loans`).push(loanData)
    
    .then((newLoanRef) => {
    // ট্রানজেকশন হিস্টোরিতে সংরক্ষণ
const transactionId = `loan_application_${Date.now()}`;
const updates = {};
updates[`/transactions/${transactionId}`] = {
    type: 'loan_application',
    loanId: newLoanRef.key,
    amount: amount,
    duration: duration,
    interestRate: interestRate,
    monthlyEMI: emi,
    totalPayable: totalPayable,
    timestamp: new Date().toISOString(),
    userId: currentUser.uid
};

return database.ref().update(updates);
})
    
    .then(() => {
        showPopup('Success', 'Your loan application has been submitted for approval.');
        document.getElementById('loan-amount').value = '';
        loadLoanData(); // Reload loan data to update available amount
    })
    .catch(error => {
        console.error("Loan application error:", error);
        showPopup('Error', 'Failed to apply for loan. Please try again.');
    });
}

function loadActiveLoans() {
    const container = document.getElementById('active-loans');
    container.innerHTML = '';
    
    if (!userData.loans) {
        container.innerHTML = '<p class="text-center">No active loans.</p>';
        return;
    }
    
    let hasActiveLoans = false;
    
    Object.entries(userData.loans).forEach(([key, loan]) => {
        // Show only approved, active, or pending loans (not paid or rejected)
        if (loan.status === 'approved' || loan.status === 'active' || loan.status === 'pending') {
            hasActiveLoans = true;
            
            const paidAmount = loan.totalPayable - (loan.remainingAmount || loan.totalPayable);
            const progressPercentage = Math.min(100, (paidAmount / loan.totalPayable) * 100);
            
            // Calculate next payment info
            const nextPaymentDate = loan.nextPaymentDate ? new Date(loan.nextPaymentDate) : null;
            const now = new Date();
            const isOverdue = nextPaymentDate && now > nextPaymentDate;
            
            const loanCard = document.createElement('div');
            loanCard.className = 'savings-card';
            loanCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: var(--primary-color); margin: 0 0 5px 0;">Loan #${key.substring(0, 6)}</h3>
                        <div style="font-size: 14px; color: #666;">${loan.planName || 'Personal Loan'} - ${loan.status.toUpperCase()}</div>
                    </div>
                    <div class="savings-badge ${loan.status}">${loan.status.toUpperCase()}</div>
                </div>
                
                ${loan.status === 'approved' || loan.status === 'active' ? `
                <div class="savings-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%;"></div>
                    </div>
                    <div class="progress-days">Paid: $${paidAmount.toFixed(2)} of $${loan.totalPayable.toFixed(2)}</div>
                </div>
                
                <div class="savings-grid">
                    <div class="savings-item">
                        <div class="savings-label">Loan Amount</div>
                        <div class="savings-value">$${loan.amount.toFixed(2)}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Interest Rate</div>
                        <div class="savings-value">${loan.interestRate}% per month</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Monthly EMI</div>
                        <div class="savings-value">$${loan.monthlyEMI.toFixed(2)}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Due Date</div>
                        <div class="savings-value">${new Date(loan.dueDate).toLocaleDateString()}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Remaining Amount</div>
                        <div class="savings-value" style="color: ${isOverdue ? 'var(--error-color)' : 'var(--primary-color)'};">$${(loan.remainingAmount || loan.totalPayable).toFixed(2)}</div>
                    </div>
                    ${nextPaymentDate ? `
                    <div class="savings-item">
                        <div class="savings-label">Next Payment Due</div>
                        <div class="savings-value" style="color: ${isOverdue ? 'var(--error-color)' : '#666'};">${nextPaymentDate.toLocaleDateString()}</div>
                    </div>
                    ` : ''}
                </div>
                
                ${loan.remainingAmount > 0 ? `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="showRepaymentPopup('${key}')">
                        <i class="fa-solid fa-credit-card"></i> Make Payment
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="showFullPaymentPopup('${key}')">
                        <i class="fa-solid fa-money-bill-wave"></i> Pay in Full
                    </button>
                </div>
                ` : ''}
                ` : `
                <div class="savings-grid">
                    <div class="savings-item">
                        <div class="savings-label">Loan Amount</div>
                        <div class="savings-value">$${loan.amount.toFixed(2)}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Status</div>
                        <div class="savings-value">${loan.status.toUpperCase()}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Applied Date</div>
                        <div class="savings-value">${new Date(loan.appliedDate).toLocaleDateString()}</div>
                    </div>
                </div>
                `}
            `;
            container.appendChild(loanCard);
        }
    });
    
    if (!hasActiveLoans) {
        container.innerHTML = '<p class="text-center">No active loans.</p>';
    }
}

function showRepaymentPopup(loanId) {
    const loan = userData.loans[loanId];
    if (!loan) return;
    
    // Calculate amount due with daily breakdown
    const dueDetails = calculateAmountDue(loan);
    
    const popupContent = `
        <h3>Make Loan Payment</h3>
        <p>Loan #${loanId.substring(0, 6)}</p>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <strong>Payment Breakdown:</strong>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 14px;">
    <div>Days Since Last Payment:</div>
    <div style="text-align: right; font-weight: 600;">${dueDetails.daysSinceLastPayment} days</div>
    
    <div>Daily EMI Rate:</div>
    <div style="text-align: right; font-weight: 600;">$${dueDetails.dailyEMI.toFixed(4)}/day</div>
    
    <div>EMI Amount:</div>
    <div style="text-align: right; font-weight: 600;">$${dueDetails.principalDue.toFixed(2)}</div>
</div>
            </div>
            
            ${dueDetails.overdueDays > 0 ? `
            <div style="border-top: 1px solid #ddd; margin-top: 10px; padding-top: 10px;">
                <div style="color: var(--error-color); font-weight: 600;">Late Payment Charges:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <div>Overdue Days:</div>
                    <div style="text-align: right;">${dueDetails.overdueDays} days</div>
                    
                    <div>Penalty Amount:</div>
                    <div style="text-align: right; color: var(--error-color);">$${dueDetails.penaltyAmount.toFixed(2)}</div>
                </div>
            </div>
            ` : ''}
            
            <div style="border-top: 2px solid var(--primary-color); margin-top: 10px; padding-top: 10px; font-weight: 600;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <div>Total Amount Due:</div>
                    <div style="text-align: right; color: var(--primary-color);">$${dueDetails.totalDue.toFixed(2)}</div>
                </div>
            </div>
        </div>
        
        <div style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
            <div style="font-size: 12px; color: #0066cc;">
                <i class="fa-solid fa-info-circle"></i> 
                You can pay any amount above the minimum due. Full payment will close the loan.
            </div>
        </div>
        
        <div class="form-group">
            <label for="repayment-amount">Payment Amount ($)</label>
            <input type="number" id="repayment-amount" class="form-control" 
                   value="${dueDetails.totalDue.toFixed(2)}" min="${dueDetails.totalDue.toFixed(2)}" 
                   max="${dueDetails.maxPossibleDue.toFixed(2)}" step="0.01">
            <div class="amount-range">
                <span>Min: $${dueDetails.totalDue.toFixed(2)}</span>
                <span>Max: $${dueDetails.maxPossibleDue.toFixed(2)}</span>
            </div>
        </div>
    `;
    
    showCustomPopup('Make Payment', popupContent, 
        () => processLoanPayment(loanId, 'partial'),
        'Pay Now'
    );
}

function showFullPaymentPopup(loanId) {
    const loan = userData.loans[loanId];
    if (!loan) return;
    
    const popupContent = `
        <h3>Full Loan Payment</h3>
        <p>Loan #${loanId.substring(0, 6)}</p>
        <div class="info-item">
            <span>Total Amount Due</span>
            <span style="color: var(--primary-color); font-weight: 600;">$${loan.remainingAmount.toFixed(2)}</span>
        </div>
        <div class="info-item">
            <span>Remaining Balance</span>
            <span>$${loan.remainingAmount.toFixed(2)}</span>
        </div>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">
            This will completely pay off your loan.
        </p>
    `;
    
    showCustomPopup('Full Payment', popupContent, 
        () => processLoanPayment(loanId, 'full'),
        'Pay in Full'
    );
}

function processLoanPayment(loanId, paymentType) {
    const loan = userData.loans[loanId];
    if (!loan) return;
    
    let paymentAmount;
    if (paymentType === 'full') {
        paymentAmount = loan.remainingAmount;
    } else {
        paymentAmount = parseFloat(document.getElementById('repayment-amount').value);
        if (isNaN(paymentAmount) || paymentAmount <= 0) {
            showPopup('Error', 'Please enter a valid payment amount.');
            return;
        }
        
        const dueDetails = calculateAmountDue(loan);
        if (paymentAmount < dueDetails.totalDue) {
            showPopup('Error', `Payment amount must be at least $${dueDetails.totalDue.toFixed(2)} to cover minimum due.`);
            return;
        }
        
        if (paymentAmount > loan.remainingAmount) {
            showPopup('Error', `Payment amount cannot exceed remaining balance of $${loan.remainingAmount.toFixed(2)}.`);
            return;
        }
    }
    
    if ((userData.balance || 0) < paymentAmount) {
        showPopup('Error', 'Insufficient balance to make this payment.');
        return;
    }
    
    const dueDetails = calculateAmountDue(loan);
    const newBalance = (userData.balance || 0) - paymentAmount;
    const newRemainingAmount = loan.remainingAmount - paymentAmount;
    
    const paymentData = {
        amount: paymentAmount,
        date: new Date().toISOString(),
        type: paymentType,
        loanId: loanId,
        dailyEMI: dueDetails.dailyEMI,
        daysCovered: dueDetails.daysSinceLastPayment,
        penaltyPaid: dueDetails.penaltyAmount,
        principalPaid: paymentAmount - dueDetails.penaltyAmount
    };
    
    const updates = {};
    updates[`/users/${currentUser.uid}/balance`] = newBalance;
    updates[`/users/${currentUser.uid}/loans/${loanId}/remainingAmount`] = newRemainingAmount;
    updates[`/users/${currentUser.uid}/loans/${loanId}/lastPaymentDate`] = new Date().toISOString();
    updates[`/users/${currentUser.uid}/loans/${loanId}/totalPenaltyPaid`] = (loan.totalPenaltyPaid || 0) + dueDetails.penaltyAmount;
    
    // Set next payment date based on payment type
    if (paymentType === 'full') {
        updates[`/users/${currentUser.uid}/loans/${loanId}/status`] = 'paid';
        updates[`/users/${currentUser.uid}/loans/${loanId}/nextPaymentDate`] = null;
    } else {
        // Set next payment date to 30 days from now
        const nextPaymentDate = new Date();
        nextPaymentDate.setDate(nextPaymentDate.getDate() + 30);
        updates[`/users/${currentUser.uid}/loans/${loanId}/nextPaymentDate`] = nextPaymentDate.toISOString();
    }
    
     
    // Add to admin's balance
    updates[`/admin/balance`] = (appSettings.adminBalance || 0) + paymentAmount;
    
    database.ref().update(updates)
    .then(() => {
        let successMessage = `Payment of $${paymentAmount.toFixed(2)} processed successfully.`;
        
        if (paymentType === 'full') {
            successMessage += ' Your loan has been fully paid.';
        } else {
            successMessage += ` Next payment due: ${new Date(updates[`/users/${currentUser.uid}/loans/${loanId}/nextPaymentDate`]).toLocaleDateString()}`;
        }
        
        showPopup('Success', successMessage);
        
        // Show payment breakdown
        const breakdown = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <strong style="color: var(--primary-color); display: block; text-align: center; margin-bottom: 10px;">Payment Breakdown</strong>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                    <div>Principal Amount:</div>
                    <div style="text-align: right; font-weight: 600;">$${paymentData.principalPaid.toFixed(2)}</div>
                    
                    <div>Days Covered:</div>
                    <div style="text-align: right;">${paymentData.daysCovered} days</div>
                    
                    ${paymentData.penaltyPaid > 0 ? `
                    <div style="color: var(--error-color);">Late Payment Fee:</div>
                    <div style="text-align: right; color: var(--error-color); font-weight: 600;">$${paymentData.penaltyPaid.toFixed(2)}</div>
                    ` : ''}
                    
                    <div style="border-top: 1px solid #ddd; padding-top: 5px; font-weight: 600;">Total Paid:</div>
                    <div style="border-top: 1px solid #ddd; padding-top: 5px; text-align: right; color: var(--primary-color); font-weight: 600;">
                        $${paymentAmount.toFixed(2)}
                    </div>
                </div>
            </div>
            
            <div style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
                <div style="font-size: 12px; color: #0066cc; text-align: center;">
                    <i class="fa-solid fa-check-circle"></i> 
                    Payment processed successfully
                </div>
            </div>
        `;

        setTimeout(() => {
            showPopup('Payment Details', breakdown);
        }, 1500);
    })
    .catch(error => {
        console.error("Loan payment error:", error);
        showPopup('Error', 'Failed to process payment. Please try again.');
    });
}

function showCustomPopup(title, content, onConfirm, confirmText = 'Confirm') {
    document.getElementById('popup-title').textContent = title;
    document.getElementById('popup-message').innerHTML = content;
    
    const buttons = document.getElementById('popup-buttons');
    buttons.innerHTML = `
        <button class="btn btn-secondary" onclick="closePopup()">Cancel</button>
        <button class="btn btn-primary" id="popup-confirm-btn">${confirmText}</button>
    `;
    
    document.getElementById('popup-confirm-btn').onclick = function() {
        onConfirm();
        closePopup();
    };
    
    document.getElementById('popup-overlay').style.display = 'flex';
}

// Helper function to calculate next payment date
function getNextPaymentDate(currentDate, monthsToAdd) {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + monthsToAdd);
    return newDate.toISOString();
}

function calculateAmountDue(loan) {
    const now = new Date();
    const lastPaymentDate = loan.lastPaymentDate ? new Date(loan.lastPaymentDate) : new Date(loan.appliedDate);
    const nextPaymentDate = new Date(loan.nextPaymentDate);
    
    let totalDue = 0;
    let dailyEMI = 0;
    let overdueDays = 0;
    let penaltyAmount = 0;
    
    // Calculate daily EMI
    if (loan.monthlyEMI && loan.duration) {
        dailyEMI = loan.monthlyEMI / 30; // Daily EMI amount
    }
    
    // Calculate days since last payment
    const daysSinceLastPayment = Math.max(0, Math.floor((now - lastPaymentDate) / (1000 * 60 * 60 * 24)));
    
    if (daysSinceLastPayment > 0) {
        // Calculate EMI for the days passed
        totalDue = dailyEMI * daysSinceLastPayment;
    }
    
    // Check if payment is overdue
    if (now > nextPaymentDate) {
        overdueDays = Math.max(0, Math.floor((now - nextPaymentDate) / (1000 * 60 * 60 * 24)));
        
        if (overdueDays > 0) {
            // Apply penalty (2% per month or as per admin settings)
            const penaltyRate = (appSettings.loanPenaltyRate || 2) / 100;
            const monthlyPenalty = loan.monthlyEMI * penaltyRate;
            penaltyAmount = monthlyPenalty * (overdueDays / 30); // Daily penalty
        }
    }
    
    // Ensure we don't charge more than remaining amount
    const maxPossibleDue = loan.remainingAmount;
    totalDue = Math.min(totalDue + penaltyAmount, maxPossibleDue);
    
    return {
        totalDue: totalDue,
        dailyEMI: dailyEMI,
        daysSinceLastPayment: daysSinceLastPayment,
        overdueDays: overdueDays,
        penaltyAmount: penaltyAmount,
        principalDue: Math.min(dailyEMI * daysSinceLastPayment, maxPossibleDue),
        interestDue: 0, // Already included in EMI
        maxPossibleDue: maxPossibleDue
    };
}

// Update loan calculations daily (should be called by admin/scheduled function)
function updateDailyLoanCalculations() {
    if (!currentUser) return;
    
    database.ref('users').once('value').then(snapshot => {
        snapshot.forEach(userSnap => {
            const user = userSnap.val();
            if (user.loans) {
                Object.entries(user.loans).forEach(([loanId, loan]) => {
                    if (loan.status === 'approved') {
                        const amountDue = calculateAmountDue(loan);
                        
                        // Update loan with new calculations
                        database.ref(`users/${userSnap.key}/loans/${loanId}`).update({
                            penaltyAmount: amountDue - loan.remainingPrincipal - (loan.totalPayable - loan.remainingAmount)
                        });
                    }
                });
            }
        });
    });
}

// Process loan payment with proper allocation
function processLoanPaymentAllocation(loanId, paymentAmount) {
    const loan = userData.loans[loanId];
    if (!loan) return null;
    
    const amountDue = calculateAmountDue(loan);
    let remainingPayment = paymentAmount;
    let principalPaid = 0;
    let interestPaid = 0;
    let penaltyPaid = 0;
    
    // First pay penalties
    if (loan.penaltyAmount > 0 && remainingPayment > 0) {
        penaltyPaid = Math.min(remainingPayment, loan.penaltyAmount);
        remainingPayment -= penaltyPaid;
    }
    
    // Then pay interest
    const interestDue = amountDue - loan.remainingPrincipal - loan.penaltyAmount;
    if (interestDue > 0 && remainingPayment > 0) {
        interestPaid = Math.min(remainingPayment, interestDue);
        remainingPayment -= interestPaid;
    }
    
    // Finally pay principal
    if (remainingPayment > 0) {
        principalPaid = Math.min(remainingPayment, loan.remainingPrincipal);
        remainingPayment -= principalPaid;
    }
    
    // Update loan details
    const newRemainingPrincipal = loan.remainingPrincipal - principalPaid;
    const newRemainingAmount = loan.remainingAmount - paymentAmount;
    const newPenaltyAmount = loan.penaltyAmount - penaltyPaid;
    
    const paymentData = {
        amount: paymentAmount,
        principal: principalPaid,
        interest: interestPaid,
        penalty: penaltyPaid,
        date: new Date().toISOString(),
        remainingPrincipal: newRemainingPrincipal,
        remainingAmount: newRemainingAmount
    };
    
    const updates = {};
    updates[`/users/${currentUser.uid}/loans/${loanId}/remainingPrincipal`] = newRemainingPrincipal;
    updates[`/users/${currentUser.uid}/loans/${loanId}/remainingAmount`] = newRemainingAmount;
    updates[`/users/${currentUser.uid}/loans/${loanId}/penaltyAmount`] = newPenaltyAmount;
    updates[`/users/${currentUser.uid}/loans/${loanId}/lastPaymentDate`] = new Date().toISOString();
    updates[`/users/${currentUser.uid}/loans/${loanId}/totalPenaltyPaid`] = (loan.totalPenaltyPaid || 0) + penaltyPaid;
    
    // Set next payment date (1 month from now)
    updates[`/users/${currentUser.uid}/loans/${loanId}/nextPaymentDate`] = getNextPaymentDate(new Date(), 1);
    
    // Add to payments array
    if (loan.payments) {
        updates[`/users/${currentUser.uid}/loans/${loanId}/payments`] = [...loan.payments, paymentData];
    } else {
        updates[`/users/${currentUser.uid}/loans/${loanId}/payments`] = [paymentData];
    }
    
    // Add to transaction history
const transactionId = `loan_payment_${Date.now()}`;
updates[`/transactions/${transactionId}`] = {
    type: 'loan_payment',
    loanId: loanId,
    amount: paymentAmount,
    principalPaid: paymentData.principalPaid || 0,
    interestPaid: paymentData.interestPaid || 0,
    penaltyPaid: paymentData.penaltyPaid || 0,
    timestamp: new Date().toISOString(),
    userId: currentUser.uid
};
    
    if (newRemainingAmount <= 0) {
        updates[`/users/${currentUser.uid}/loans/${loanId}/status`] = 'completed';
    }
    
    return updates;
}
        
        // --- P2P ---
        function switchP2PTab(tab) {
             document.getElementById('p2p-buy-tab').classList.toggle('active', tab === 'buy');
             document.getElementById('p2p-sell-tab').classList.toggle('active', tab === 'sell');
             const container = document.getElementById('p2p-offers-container');
             container.innerHTML = '<p class="text-center">Loading offers...</p>';
             
             // Load P2P offers based on selected tab
             loadP2POffers(tab);
        }
        
        function loadP2POffers(type) {
            const container = document.getElementById('p2p-offers-container');
            container.innerHTML = '';
            
            database.ref('p2pOffers').orderByChild('type').equalTo(type).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p class="text-center">No offers available at the moment.</p>';
                    return;
                }
                
                snapshot.forEach(child => {
                    const offer = child.val();
                    const offerKey = child.key;
                    
                    // Skip offers from current user
                    if (offer.userId === currentUser.uid) return;
                    
                    // Get user info
                    database.ref(`users/${offer.userId}`).once('value').then(userSnap => {
                        const user = userSnap.val();
                        if (!user) return;
                        
                        const offerElement = document.createElement('div');
                        offerElement.className = 'p2p-offer';
                        offerElement.innerHTML = `
                            <div class="p2p-offer-header">
                                <div class="p2p-user">
                                    <img src="${user.profileImage || 'https://i.pravatar.cc/150'}" class="p2p-user-avatar" alt="User">
                                    <span class="online-status ${Math.random() > 0.3 ? 'online' : 'offline'}"></span>
                                    <div>
                                        <div class="admin-name">${user.fullName}</div>
                                        <div class="p2p-rating">★★★★☆</div>
                                    </div>
                                </div>
                                <div class="p2p-price">$${offer.price}</div>
                            </div>
                            <div class="p2p-offer-details">
                                <div>Limit</div>
                                <div>$${offer.minAmount} - $${offer.maxAmount}</div>
                                <div>Available</div>
                                <div>$${offer.available}</div>
                            </div>
                            <div class="p2p-payment-methods">
                                ${offer.paymentMethods.split(',').map(method => `<span class="p2p-payment-tag">${method.trim()}</span>`).join('')}
                            </div>
                            <button class="btn btn-primary mt-2" onclick="initiateP2PTrade('${offerKey}')">${type === 'buy' ? 'Sell' : 'Buy'} Now</button>
                        `;
                        container.appendChild(offerElement);
                    });
                });
            });
        }
        
        function showP2POfferForm(type) {
            document.getElementById('p2p-offer-form-title').textContent = `Create ${type === 'buy' ? 'Buy' : 'Sell'} Offer`;
            document.getElementById('p2p-offer-type').value = type;
            document.getElementById('p2p-offer-form').style.display = 'block';
            
            // Load coin types
            if (Object.keys(exchangeRates).length > 0) {
                const coinSelect = document.getElementById('p2p-coin-type');
                coinSelect.innerHTML = '';
                Object.keys(exchangeRates).forEach(coin => {
                    coinSelect.innerHTML += `<option value="${coin}">${coin.toUpperCase()}</option>`;
                });
            }
        }
        
        function cancelP2POfferForm() {
            document.getElementById('p2p-offer-form').style.display = 'none';
        }
        
        function createP2POffer() {
            const type = document.getElementById('p2p-offer-type').value;
            const coinType = document.getElementById('p2p-coin-type').value;
            const price = parseFloat(document.getElementById('p2p-price').value);
            const minAmount = parseFloat(document.getElementById('p2p-min-amount').value);
            const maxAmount = parseFloat(document.getElementById('p2p-max-amount').value);
            const paymentMethods = document.getElementById('p2p-payment-methods').value;
            
            if (isNaN(price) || price <= 0) {
                showPopup('Error', 'Please enter a valid price.');
                return;
            }
            
            if (isNaN(minAmount) || minAmount <= 0) {
                showPopup('Error', 'Please enter a valid minimum amount.');
                return;
            }
            
            if (isNaN(maxAmount) || maxAmount <= minAmount) {
                showPopup('Error', 'Please enter a valid maximum amount.');
                return;
            }
            
            if (!paymentMethods) {
                showPopup('Error', 'Please enter at least one payment method.');
                return;
            }
            
            const offerData = {
                type: type,
                coinType: coinType,
                price: price,
                minAmount: minAmount,
                maxAmount: maxAmount,
                available: maxAmount,
                paymentMethods: paymentMethods,
                userId: currentUser.uid,
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            database.ref('p2pOffers').push(offerData)
            .then(() => {
                showPopup('Success', 'Your P2P offer has been created successfully!');
                cancelP2POfferForm();
                switchP2PTab(type);
            })
            .catch(error => {
                showPopup('Error', 'Failed to create P2P offer. Please try again.');
            });
        }
        
        function showMyP2POffers() {
            const container = document.getElementById('p2p-offers-container');
            container.innerHTML = '<p class="text-center">Loading your offers...</p>';
            
            database.ref('p2pOffers').orderByChild('userId').equalTo(currentUser.uid).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p class="text-center">You have not created any offers yet.</p>';
                    return;
                }
                
                container.innerHTML = '<h3 class="section-title">Your P2P Offers</h3>';
                
                snapshot.forEach(child => {
                    const offer = child.val();
                    const offerKey = child.key;
                    
                    const offerElement = document.createElement('div');
                    offerElement.className = 'p2p-offer';
                    offerElement.innerHTML = `
                        <div class="p2p-offer-header">
                            <div>
                                <div class="admin-name">${offer.type.toUpperCase()} ${offer.coinType.toUpperCase()}</div>
                                <div>Created: ${new Date(offer.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div class="p2p-price">$${offer.price}</div>
                        </div>
                        <div class="p2p-offer-details">
                            <div>Limit</div>
                            <div>$${offer.minAmount} - $${offer.maxAmount}</div>
                            <div>Available</div>
                            <div>$${offer.available}</div>
                            <div>Status</div>
                            <div>${offer.status}</div>
                        </div>
                        <div class="p2p-payment-methods">
                            ${offer.paymentMethods.split(',').map(method => `<span class="p2p-payment-tag">${method.trim()}</span>`).join('')}
                        </div>
                        <button class="btn btn-secondary mt-2" onclick="deleteP2POffer('${offerKey}')">Delete Offer</button>
                    `;
                    container.appendChild(offerElement);
                });
            });
        }
        
        function initiateP2PTrade(offerId) {
            showPopup('P2P Trade', 'This feature will be implemented in the next version.');
        }
        
        function deleteP2POffer(offerId) {
            showConfirmationPopup(
                'Delete Offer',
                'Are you sure you want to delete this P2P offer?',
                () => {
                    database.ref(`p2pOffers/${offerId}`).remove()
                    .then(() => {
                        showPopup('Success', 'P2P offer deleted successfully.');
                        showMyP2POffers();
                    })
                    .catch(error => {
                        showPopup('Error', 'Failed to delete P2P offer.');
                    });
                }
            );
        }
        
        // --- Exchange ---
        function loadExchangeRates() {
            database.ref('exchangeRates').once('value').then(snapshot => {
                const rates = snapshot.val();
                if (rates) {
                    exchangeRates = rates;
                    
                    const fromCoin = document.getElementById('from-coin');
                    const toCoin = document.getElementById('to-coin');
                    
                    fromCoin.innerHTML = '';
                    toCoin.innerHTML = '';
                    
                    Object.keys(rates).forEach(coin => {
                        fromCoin.innerHTML += `<option value="${coin}">${coin}</option>`;
                        toCoin.innerHTML += `<option value="${coin}">${coin}</option>`;
                    });
                    
                    calculateExchange();
                }
            });
        }
        
        function calculateExchange() {
            if (typeof exchangeRates !== 'object' || Object.keys(exchangeRates).length === 0) return;
            const fromCoin = document.getElementById('from-coin').value;
            const toCoin = document.getElementById('to-coin').value;
            const fromAmount = parseFloat(document.getElementById('from-amount').value) || 0;
            
            if (fromCoin === toCoin) {
                document.getElementById('to-amount').value = fromAmount.toFixed(8);
                document.getElementById('exchange-rate').textContent = '1';
                return;
            }
            
            const rate = exchangeRates[fromCoin]?.[toCoin] || 0;
            document.getElementById('to-amount').value = (fromAmount * rate).toFixed(8);
            document.getElementById('exchange-rate').textContent = rate;
            document.getElementById('from-coin-label').textContent = fromCoin;
            document.getElementById('to-coin-label').textContent = toCoin;
        }
        
        function executeExchange(){
            const fromCoin = document.getElementById('from-coin').value;
            const toCoin = document.getElementById('to-coin').value;
            const fromAmount = parseFloat(document.getElementById('from-amount').value) || 0;
            const toAmount = parseFloat(document.getElementById('to-amount').value) || 0;
            
            if (fromAmount <= 0) {
                showPopup('Error', 'Please enter a valid amount.');
                return;
            }
            
            if (!userData.coins) userData.coins = {};
            if (!userData.coins[fromCoin] || userData.coins[fromCoin] < fromAmount) {
                showPopup('Error', `Insufficient ${fromCoin} balance.`);
                return;
            }
            
            // Update user's coin balances
            const newFromAmount = (userData.coins[fromCoin] || 0) - fromAmount;
            const newToAmount = (userData.coins[toCoin] || 0) + toAmount;
            
            const updates = {};
            updates[`/users/${currentUser.uid}/coins/${fromCoin}`] = newFromAmount;
            updates[`/users/${currentUser.uid}/coins/${toCoin}`] = newToAmount;
            
            database.ref().update(updates)
            .then(() => {
                showPopup('Success', `Successfully exchanged ${fromAmount} ${fromCoin} for ${toAmount} ${toCoin}.`);
                userData.coins[fromCoin] = newFromAmount;
                userData.coins[toCoin] = newToAmount;
                document.getElementById('from-amount').value = '';
                document.getElementById('to-amount').value = '';
            })
            .catch(error => {
                showPopup('Error', 'Exchange failed. Please try again.');
            });
        }
        
        // --- Profile Gallery ---
function showProfileGallery() {
    // Load gallery images from Firebase
    loadProfileGallery();
    
    // Show admin upload section if user is admin
    if (isAdmin()) {
        const adminUploadSection = `
            <div id="admin-image-upload" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">Admin Panel - Add New Image</h4>
                <div class="form-group">
                    <label for="new-image-url">Image URL</label>
                    <input type="url" id="new-image-url" class="form-control" placeholder="https://example.com/image.jpg">
                </div>
                <button class="btn btn-primary" onclick="addNewImage()">Add to Gallery</button>
            </div>
        `;
        
        const galleryContainer = document.querySelector('.gallery-container');
        if (galleryContainer && !galleryContainer.querySelector('#admin-image-upload')) {
            galleryContainer.insertAdjacentHTML('afterbegin', adminUploadSection);
        }
    }
    
    document.getElementById('gallery-popup').style.display = 'flex';
}

function loadProfileGallery() {
    const galleryGrid = document.querySelector('.gallery-grid');
    if (!galleryGrid) return;
    
    galleryGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading images...</div>';
    
    database.ref('profileGallery/images').orderByChild('active').equalTo(true).once('value').then(snapshot => {
        galleryGrid.innerHTML = '';
        
        if (snapshot.exists()) {
            snapshot.forEach(child => {
                const image = child.val();
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.innerHTML = `<img src="${image.url}" alt="Profile Image" onerror="this.src='https://i.pravatar.cc/150'">`;
                galleryItem.onclick = () => selectGalleryImage(galleryItem, image.url);
                galleryGrid.appendChild(galleryItem);
            });
        } else {
            galleryGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No images available</div>';
        }
    }).catch(error => {
        console.error("Error loading gallery:", error);
        galleryGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Error loading images</div>';
    });
}

function selectGalleryImage(el, imgUrl) {
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.classList.remove('selected');
    });
    el.classList.add('selected');
    selectedProfileImage = imgUrl;
}

function handleCustomProfilePic(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedProfileImage = e.target.result;
            
            // Create a new gallery item for the custom image
            const galleryGrid = document.querySelector('.gallery-grid');
            const newItem = document.createElement('div');
            newItem.className = 'gallery-item selected';
            newItem.innerHTML = `<img src="${e.target.result}" alt="Custom Profile">`;
            newItem.onclick = function() {
                selectGalleryImage(this, e.target.result);
            };
            
            // Remove previous selection and add new item
            document.querySelectorAll('.gallery-item').forEach(item => {
                item.classList.remove('selected');
            });
            galleryGrid.appendChild(newItem);
            newItem.classList.add('selected');
        };
        reader.readAsDataURL(file);
    }
}

function saveProfilePicture() {
    if (!selectedProfileImage) {
        showPopup('Error', 'Please select a profile picture.');
        return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('.gallery-container .btn-primary');
    const originalText = saveBtn.textContent;
    saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
    saveBtn.disabled = true;
    
    // Check if it's a data URL (custom upload) or regular URL
    if (selectedProfileImage.startsWith('data:image/')) {
        // Upload custom image to Firebase Storage first
        uploadCustomProfilePicture(selectedProfileImage);
    } else {
        // It's a URL from the gallery
        updateProfilePicture(selectedProfileImage);
    }
}

function uploadCustomProfilePicture(imageDataUrl) {
    const storageRef = storage.ref(`profile_pictures/${currentUser.uid}_${Date.now()}.jpg`);
    
    // Convert data URL to blob
    fetch(imageDataUrl)
        .then(res => res.blob())
        .then(blob => {
            const uploadTask = storageRef.put(blob);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Upload progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                },
                (error) => {
                    // Upload failed
                    console.error('Upload failed:', error);
                    showPopup('Error', 'Failed to upload image. Please try again.');
                    resetSaveButton();
                },
                () => {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        updateProfilePicture(downloadURL);
                    });
                }
            );
        })
        .catch(error => {
            console.error('Error converting image:', error);
            showPopup('Error', 'Invalid image file.');
            resetSaveButton();
        });
}

function updateProfilePicture(imageUrl) {
    database.ref('users/' + currentUser.uid).update({
        profileImage: imageUrl
    })
    .then(() => {
        showPopup('Success', 'Profile picture updated successfully.');
        userData.profileImage = imageUrl;
        updateUIWithUserData();
        closeGallery();
    })
    .catch(error => {
        console.error('Update profile error:', error);
        showPopup('Error', 'Failed to update profile picture. Please check your internet connection.');
    })
    .finally(() => {
        resetSaveButton();
    });
}

function resetSaveButton() {
    const saveBtn = document.querySelector('.gallery-container .btn-primary');
    if (saveBtn) {
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
    }
}

function closeGallery() {
    document.getElementById('gallery-popup').style.display = 'none';
    // Reset custom file input
    const customFileInput = document.getElementById('custom-profile-pic');
    if (customFileInput) {
        customFileInput.value = '';
    }
    
    // Remove admin upload section
    const adminUpload = document.getElementById('admin-image-upload');
    if (adminUpload) {
        adminUpload.remove();
    }
    
    // Reset selection
    selectedProfileImage = null;
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.classList.remove('selected');
    });
}

function togglePasswordVisibility() {
    const passwordInput = document.getElementById('password-display');
    const eyeIcon = passwordInput.nextElementSibling;
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

// Admin functions for profile gallery
function isAdmin() {
    return userData && userData.isAdmin === true;
}

function addNewImage() {
    const imageUrlInput = document.getElementById('new-image-url');
    const imageUrl = imageUrlInput.value.trim();
    
    if (!imageUrl) {
        showPopup('Error', 'Please enter image URL');
        return;
    }
    
    if (!imageUrl.startsWith('http')) {
        showPopup('Error', 'Please enter a valid URL starting with http:// or https://');
        return;
    }
    
    if (!isAdmin()) {
        showPopup('Error', 'Only admins can add gallery images');
        return;
    }
    
    const imageData = {
        url: imageUrl,
        active: true,
        addedBy: currentUser.uid,
        addedDate: new Date().toISOString()
    };
    
    // Show loading
    const addBtn = document.querySelector('#admin-image-upload .btn');
    const originalText = addBtn.textContent;
    addBtn.innerHTML = '<span class="spinner"></span> Adding...';
    addBtn.disabled = true;
    
    database.ref('profileGallery/images').push(imageData)
    .then(() => {
        showPopup('Success', 'Image added to gallery successfully');
        imageUrlInput.value = '';
        loadProfileGallery(); // Refresh gallery
    })
    .catch(error => {
        console.error("Add image error:", error);
        showPopup('Error', 'Failed to add image to gallery. Please check the URL.');
    })
    .finally(() => {
        addBtn.textContent = originalText;
        addBtn.disabled = false;
    });
}

        // --- Referral System ---
        function loadReferralData() {
            if (!userData.referralCode) {
                userData.referralCode = generateReferralCode();
                database.ref('users/' + currentUser.uid).update({
                    referralCode: userData.referralCode
                });
            }
            
            document.getElementById('user-referral-code').textContent = userData.referralCode;
            
            // Load referral stats
            database.ref('users').orderByChild('referredBy').equalTo(userData.referralCode).once('value').then(snapshot => {
                const totalReferrals = snapshot.numChildren();
                let activeReferrals = 0;
                let referralEarnings = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = child.val();
                        if (user.balance > 0) activeReferrals++;
                        // Calculate earnings based on user activity
                        if (user.totalDeposits) {
                            referralEarnings += user.totalDeposits * (appSettings.referralPercentage || 0.05);
                        }
                    });
                }
                
                document.getElementById('total-referrals').textContent = totalReferrals;
                document.getElementById('active-referrals').textContent = activeReferrals;
                document.getElementById('referral-earnings').textContent = `$${referralEarnings.toFixed(2)}`;
                
                // Load referral list
                loadReferralList(snapshot);
            });
        }
        
        function loadReferralList(snapshot) {
    const listContainer = document.getElementById('referral-list');
    listContainer.innerHTML = '';
    
    if (!snapshot.exists()) {
        listContainer.innerHTML = '<p class="text-center">You have not referred any users yet.</p>';
        return;
    }
    
    snapshot.forEach(child => {
        const user = child.val();
        // Calculate commission (5% of user's total deposits)
        const commission = user.totalDeposits ? (user.totalDeposits * 0.05).toFixed(2) : '0.00';
        
        const listItem = document.createElement('div');
        listItem.className = 'referral-item';
        listItem.innerHTML = `
            <div class="referral-user-info">
                <img src="${user.profileImage || 'https://i.pravatar.cc/150'}" class="referral-avatar" alt="User">
                <div class="referral-details">
                    <div class="referral-name">${user.fullName}</div>
                    <div class="referral-date">Joined: ${new Date(user.joinDate).toLocaleDateString()}</div>
                </div>
            </div>
            <div class="referral-commission">
                <div class="commission-amount">$${commission}</div>
                <div class="commission-label">Commission</div>
            </div>
        `;
        listContainer.appendChild(listItem);
    });
}
        
        function copyReferralCode() {
            const referralCode = document.getElementById('user-referral-code').textContent;
            navigator.clipboard.writeText(referralCode).then(() => {
                showPopup('Success', 'Referral code copied to clipboard!');
            }).catch(err => {
                showPopup('Error', 'Failed to copy referral code.');
            });
        }
        
        // --- Savings Plans ---
        function loadSavingsPlans() {
    const container = document.getElementById('savings-plans');
    container.innerHTML = '';
    
    database.ref('savingsPlans').orderByChild('active').equalTo(true).once('value').then(snapshot => {
        if (!snapshot.exists()) {
            container.innerHTML = '<div class="no-plans-message"><i class="fa-solid fa-piggy-bank"></i><p>No savings plans available at the moment</p></div>';
            return;
        }
        
        snapshot.forEach(child => {
            const plan = child.val();
            const planKey = child.key;
            
           // Calculate daily return (total percentage divided by duration in days)
const dailyReturnPercentage = (plan.interestRate / plan.duration).toFixed(3);
const totalReturn = plan.interestRate;
            
            const planCard = document.createElement('div');
            planCard.className = 'savings-plan-card';
            planCard.innerHTML = `
                <div class="plan-header">
                    <div class="plan-badge">${plan.duration} Days</div>
                    <div class="plan-icon"><i class="fa-solid fa-chart-line"></i></div>
                </div>
                
                <h3 class="plan-title">${plan.name}</h3>
                
                <div class="plan-return">
                    <div class="return-percentage">${plan.interestRate}%</div>
                    <div class="return-label">Total Return</div>
                </div>
                
                <div class="plan-details">
                    <div class="detail-item">
                        <i class="fa-solid fa-calendar-days"></i>
                        <span>${plan.duration} Days Term</span>
                    <div class="detail-item">
    <i class="fa-solid fa-coins"></i>
    <span>Daily Return: ${dailyReturnPercentage}%</span>
</div>
                    <div class="detail-item">
                        <i class="fa-solid fa-wallet"></i>
                        <span>Min: $${plan.minAmount}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fa-solid fa-sack-dollar"></i>
                        <span>Max: $${plan.maxAmount}</span>
                    </div>
                </div>
                
                <div class="plan-example">
                    <div class="example-title">Example Returns:</div>
                    <div class="example-amounts">
                        <div class="example-item">
                            <span>$${plan.minAmount} → $${(plan.minAmount * (1 + plan.interestRate/100)).toFixed(2)}</span>
                        </div>
                        <div class="example-item">
                            <span>$${plan.maxAmount} → $${(plan.maxAmount * (1 + plan.interestRate/100)).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn-plan-primary" onclick="showSavingsAmountInput('${planKey}', ${plan.minAmount}, ${plan.maxAmount})">
                    <i class="fa-solid fa-lock-open"></i>
                    Start Saving Now
                </button>
                
                <div id="amount-input-${planKey}" class="amount-input-container">
                    <div class="input-header">
                        <h4>Activate ${plan.name}</h4>
                        <button class="close-btn" onclick="hideSavingsAmountInput('${planKey}')">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="savings-amount-${planKey}">Investment Amount ($)</label>
                        <div class="amount-input-wrapper">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="savings-amount-${planKey}" class="form-control" 
                                   placeholder="Enter amount" min="${plan.minAmount}" max="${plan.maxAmount}"
                                   oninput="calculateSavingsReturn('${planKey}', ${plan.interestRate}, ${plan.duration})">
                        </div>
                        <div class="amount-range">
                            <span>Min: $${plan.minAmount}</span>
                            <span>Max: $${plan.maxAmount}</span>
                        </div>
                    </div>
                    
                    <div id="return-calculation-${planKey}" class="return-calculation">
                        <div class="return-item">
                            <span>Total Return:</span>
                            <span id="total-return-${planKey}">$0.00</span>
                        </div>
                        <div class="return-item">
                            <span>Daily Profit:</span>
                            <span id="daily-profit-${planKey}">$0.00</span>
                        </div>
                        <div class="return-item final">
                            <span>Final Amount:</span>
                            <span id="final-amount-${planKey}">$0.00</span>
                        </div>
                    </div>
                    
                    <button class="btn-plan-confirm" onclick="activateSavings('${planKey}')">
                        <i class="fa-solid fa-check"></i>
                        Confirm Investment
                    </button>
                </div>
            `;
            container.appendChild(planCard);
        });
    });
    
    // Load active savings
    loadActiveSavings();
}
        
        function activateSavings(planKey) {
    const amountInput = document.getElementById(`savings-amount-${planKey}`);
    const amount = parseFloat(amountInput.value);
    
    if (!amount || amount <= 0) {
        showPopup('Error', 'Please enter a valid amount.');
        return;
    }
    
    database.ref(`savingsPlans/${planKey}`).once('value').then(snapshot => {
        const plan = snapshot.val();
        if (!plan) return;
        
        if (amount < plan.minAmount) {
            showPopup('Error', `Minimum amount is $${plan.minAmount}.`);
            return;
        }
        
        if (amount > plan.maxAmount) {
            showPopup('Error', `Maximum amount is $${plan.maxAmount}.`);
            return;
        }
        
        if ((userData.balance || 0) < amount) {
            showPopup('Error', 'Insufficient balance.');
            return;
        }
        
        // Calculate expected interest based on admin's interest rate
        const expectedInterest = amount * (plan.interestRate / 100);
        const dailyProfit = expectedInterest / plan.duration;
        
        const savingsData = {
            planId: planKey,
            planName: plan.name,
            amount: amount,
            interestRate: plan.interestRate, // Admin's set interest rate
            expectedInterest: expectedInterest,
            dailyProfit: dailyProfit,
            totalProfitPaid: 0,
            lastProfitDate: new Date().toISOString(),
            startDate: new Date().toISOString(),
            maturityDate: new Date(Date.now() + plan.duration * 24 * 60 * 60 * 1000).toISOString(),
            status: 'active'
        };
        
        // Deduct amount from balance and activate savings
        const newBalance = (userData.balance || 0) - amount;
        
        const updates = {};
        updates[`/users/${currentUser.uid}/balance`] = newBalance;

        // Generate a unique key for the savings plan
        const savingsRef = database.ref(`users/${currentUser.uid}/savings`).push();
        updates[`/users/${currentUser.uid}/savings/${savingsRef.key}`] = savingsData;
        
        database.ref().update(updates)
        .then(() => {
            showPopup('Success', `Savings plan activated successfully! $${amount.toFixed(2)} has been deducted from your balance.`);
            userData.balance = newBalance;
            updateUIWithUserData();
            hideSavingsAmountInput(planKey);
            loadActiveSavings();
        })
        .catch(error => {
            console.error("Savings activation error:", error);
            showPopup('Error', 'Failed to activate savings plan. Please try again.');
        });
    });
}
        
        function loadActiveSavings() {
    const container = document.getElementById('active-savings-list');
    container.innerHTML = '';
    
    if (!userData.savings) {
        container.innerHTML = '<p class="text-center">No active savings plans.</p>';
        return;
    }
    
    Object.entries(userData.savings).forEach(([key, savings]) => {
        if (savings.status === 'active' || savings.status === 'pending') {
            // Calculate days completed and remaining
            const startDate = new Date(savings.startDate);
            const maturityDate = new Date(savings.maturityDate);
            const today = new Date();
            
            const totalDays = Math.ceil((maturityDate - startDate) / (1000 * 60 * 60 * 24));
            const daysCompleted = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            const daysRemaining = totalDays - daysCompleted;
            
            const progressPercentage = Math.min(100, (daysCompleted / totalDays) * 100);
            
            // Calculate daily profit and current value
            const dailyProfit = (savings.amount * (savings.interestRate / 100)) / totalDays;
            const profitEarnedSoFar = dailyProfit * daysCompleted;
            const currentValue = savings.amount + profitEarnedSoFar;
            
            const savingsCard = document.createElement('div');
            savingsCard.className = 'savings-card';
            savingsCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: var(--primary-color); margin: 0 0 5px 0;">${savings.planName}</h3>
                        <div class="savings-percentage" style="margin-left: 0;">${savings.interestRate}% Return</div>
                    </div>
                    <div class="savings-badge">Active</div>
                </div>
                
                <div class="savings-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%;"></div>
                    </div>
                    <div class="progress-days">${daysCompleted}/${totalDays} Days Completed</div>
                </div>
                
                <div class="savings-grid">
                    <div class="savings-item">
                        <div class="savings-label">Invested Amount</div>
                        <div class="savings-value">$${(savings.amount || 0).toFixed(2)}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Start Date</div>
                        <div class="savings-value">${new Date(savings.startDate).toLocaleDateString()}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">End Date</div>
                        <div class="savings-value">${new Date(savings.maturityDate).toLocaleDateString()}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Duration</div>
                        <div class="savings-value">${totalDays} Days</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Total Return</div>
                        <div class="savings-value profit">+ $${(savings.expectedInterest || 0).toFixed(2)}</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Daily Profit</div>
                        <div class="savings-value">$${dailyProfit.toFixed(2)} / day</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Profit Added</div>
                        <div class="savings-value">Daily</div>
                    </div>
                    <div class="savings-item">
                        <div class="savings-label">Current Value</div>
                        <div class="savings-value total">$${currentValue.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="savings-countdown">
                    <i class="fa-solid fa-clock"></i>
                    <span>${daysRemaining} days remaining</span>
                </div>
            `;
            container.appendChild(savingsCard);
        }
    });
}

// Daily profit distribution function (should be called periodically, e.g., once per day)
function distributeDailyProfits() {
    if (!currentUser) return;
    
    const today = new Date().toDateString();
    
    database.ref('users').once('value').then(snapshot => {
        snapshot.forEach(userSnap => {
            const user = userSnap.val();
            if (user.savings) {
                Object.entries(user.savings).forEach(([savingsId, savings]) => {
                    if (savings.status === 'active') {
                        const lastProfitDate = new Date(savings.lastProfitDate || savings.startDate).toDateString();
                        
                        // Check if profit already distributed today
                        if (lastProfitDate !== today) {
                            const dailyProfit = savings.dailyProfit || (savings.expectedInterest / savings.duration);
                            
                            // Record profit distribution
                            const profitData = {
                                userId: userSnap.key,
                                savingsId: savingsId,
                                planName: savings.planName,
                                amount: dailyProfit,
                                distributionDate: new Date().toISOString(),
                                status: 'completed'
                            };
                            
                            // Update user balance and savings record
                            const newBalance = (user.balance || 0) + dailyProfit;
                            const newTotalProfitPaid = (savings.totalProfitPaid || 0) + dailyProfit;
                            
                            const updates = {};
                            updates[`/users/${userSnap.key}/balance`] = newBalance;
                            updates[`/users/${userSnap.key}/savings/${savingsId}/totalProfitPaid`] = newTotalProfitPaid;
                            updates[`/users/${userSnap.key}/savings/${savingsId}/lastProfitDate`] = new Date().toISOString();
                            updates[`/daily_profits/${Date.now()}`] = profitData;
                            
                         // Add to transaction history
const transactionId = `savings_profit_${Date.now()}_${userSnap.key}`;
updates[`/transactions/${transactionId}`] = {
    userId: userSnap.key,
    type: 'profit',
    amount: dailyProfit,
    description: `Daily profit from ${savings.planName}`,
    timestamp: new Date().toISOString(),
    status: 'completed'
};
                            
                            database.ref().update(updates);
                        }
                    }
                });
            }
        });
    });
}

// Record savings profit transaction
function recordSavingsProfitTransaction(userId, savingsId, amount, description) {
    const transactionId = `savings_profit_${Date.now()}`;
    const transactionData = {
        type: 'profit',
        userId: userId,
        savingsId: savingsId,
        amount: amount,
        description: description,
        timestamp: new Date().toISOString()
    };
    
    return database.ref(`transactions/${transactionId}`).set(transactionData);
}

function loadProfitHistory() {
    const container = document.getElementById('profit-history-list');
    container.innerHTML = '<p class="text-center">Loading profit history...</p>';
    
    database.ref('daily_profits').orderByChild('userId').equalTo(currentUser.uid).once('value').then(snapshot => {
        container.innerHTML = '';
        
        if (!snapshot.exists()) {
            container.innerHTML = '<p class="text-center">No profit history found.</p>';
            return;
        }
        
        const profits = [];
        snapshot.forEach(child => {
            profits.push({ id: child.key, ...child.val() });
        });
        
        // Sort by date (newest first)
        profits.sort((a, b) => new Date(b.distributionDate) - new Date(a.distributionDate));
        
        profits.forEach(profit => {
            const profitItem = document.createElement('div');
            profitItem.className = 'history-item';
            profitItem.innerHTML = `
                <div>
                    <div>${profit.planName} Profit</div>
                    <div style="font-size: 12px; color: #777;">
                        ${new Date(profit.distributionDate).toLocaleDateString()} 
                        ${new Date(profit.distributionDate).toLocaleTimeString()}
                    </div>
                </div>
                <div style="color: var(--success-color); font-weight: 600;">
                    +$${profit.amount.toFixed(2)}
                </div>
            `;
            container.appendChild(profitItem);
        });
    });
}

// Call this function once per day (you can use a cron job or Firebase scheduled function)
// For testing, you can call it manually
        
        // --- Transaction History ---
function loadTransactionHistory(filter) {
    currentHistoryFilter = filter;
    const listContainer = document.getElementById('history-list');
    listContainer.innerHTML = '<p class="text-center">Loading transactions...</p>';
    
    // Update filter buttons
    document.querySelectorAll('.transaction-history-filters .btn').forEach(btn => {
        btn.classList.remove('history-filter-active');
    });
    event.target.classList.add('history-filter-active');
    
    database.ref('transactions').orderByChild('timestamp').once('value').then(snapshot => {
        listContainer.innerHTML = '';
        let hasTransactions = false;
        
        if (snapshot.exists()) {
            const transactions = [];
            
            snapshot.forEach(child => {
                const transaction = child.val();
                
                // Check if transaction belongs to current user
                const isUserTransaction = transaction.userId === currentUser.uid || 
                                         transaction.from === currentUser.uid || 
                                         transaction.to === currentUser.uid;
                
                if (!isUserTransaction) return;
                
                
               // Filter transactions based on type
if (
    (filter === 'all') ||
    (filter === 'deposit' && transaction.type === 'deposit') ||
    (filter === 'withdraw' && transaction.type === 'withdrawal') ||
    (filter === 'sent' && transaction.type === 'transfer' && transaction.from === currentUser.uid) ||
    (filter === 'received' && transaction.type === 'transfer' && transaction.to === currentUser.uid) ||
    (filter === 'product_sale' && transaction.type === 'product_sale') ||
    (filter === 'buy_product' && transaction.type === 'buy_product') ||
    (filter === 'loan' && (transaction.type === 'loan_payment' || transaction.type === 'loan_application' || transaction.type === 'loan_approved' || transaction.type === 'loan_rejected')) ||
    (filter === 'savings' && transaction.type === 'profit')
) {
                    transactions.push(transaction);
                    hasTransactions = true;
                }
            });
            
            // Sort by timestamp (newest first)
            transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (!hasTransactions) {
                listContainer.innerHTML = '<p class="text-center">No transactions found.</p>';
                return;
            }
            
            // Get product names for buy_product transactions
            const productPromises = transactions.map(transaction => {
                if (transaction.type === 'buy_product' || transaction.type === 'product_sale') {
                    return database.ref(`products/${transaction.productId}`).once('value')
                        .then(productSnapshot => {
                            return { transaction, product: productSnapshot.val() };
                        });
                }
                return Promise.resolve({ transaction });
            });
            
            Promise.all(productPromises).then(results => {
                results.forEach(({ transaction, product }) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    let description = '';
                    let amountText = '';
                    let amountClass = '';
                    
                    switch(transaction.type) {
                        case 'buy_product':
                            description = `Buy Product: ${product ? product.name : 'Unknown Product'}`;
                            amountText = `-$${transaction.amount.toFixed(2)}`;
                            amountClass = 'error-color';
                            
                            item.innerHTML = `
                                <div>
                                    <div>${description}</div>
                                    <div style="font-size: 12px; color: #777;">
                                        ${new Date(transaction.timestamp).toLocaleDateString()}
                                    </div>
                                </div>
                                <div style="color: var(--${amountClass}); font-weight: 600;">
                                    ${amountText}
                                </div>
                            `;
                            break;
                            
                        case 'product_sale':
                            description = `Sold: ${product ? product.name : 'Unknown Product'}`;
                            amountText = `+$${transaction.sellingPrice.toFixed(2)}`;
                            amountClass = 'success-color';
                            
                            // Add profit/loss details
                            item.innerHTML = `
                                <div>
                                    <div>${description}</div>
                                    <div style="font-size: 12px; color: #777;">
                                        ${new Date(transaction.timestamp).toLocaleDateString()}
                                        ${transaction.profit >= 0 ? 
                                            `<span style="color: var(--success-color);">+$${transaction.profit.toFixed(2)} (${transaction.profitPercentage}%)</span>` : 
                                            `<span style="color: var(--error-color);">-$${Math.abs(transaction.profit).toFixed(2)} (${transaction.profitPercentage}%)</span>`
                                        }
                                    </div>
                                </div>
                                <div style="color: var(--${amountClass}); font-weight: 600;">
                                    ${amountText}
                                </div>
                            `;
                            break;
                            
                        case 'profit':
                            description = transaction.description || 'Savings Profit';
                            amountText = `+$${transaction.amount.toFixed(2)}`;
                            amountClass = 'success-color';
                            item.innerHTML = `
                                <div>
                                    <div>${description}</div>
                                    <div style="font-size: 12px; color: #777;">${new Date(transaction.timestamp).toLocaleDateString()}</div>
                                </div>
                                <div style="color: var(--${amountClass}); font-weight: 600;">
                                    ${amountText}
                                </div>
                            `;
                            break;
                            
                        case 'transfer':
                            const isSent = transaction.from === currentUser.uid;
                            description = isSent ? `Sent to ${transaction.toEmail}` : `Received from ${transaction.fromEmail}`;
                            amountText = `${isSent ? '-' : '+'}$${transaction.amount.toFixed(2)}`;
                            amountClass = isSent ? 'error-color' : 'success-color';
                            
                            item.innerHTML = `
                                <div>
                                    <div>${description}</div>
                                    <div style="font-size: 12px; color: #777;">${new Date(transaction.timestamp).toLocaleDateString()}</div>
                                    ${transaction.note ? `<div style="font-size: 12px; color: #777;">Note: ${transaction.note}</div>` : ''}
                                </div>
                                <div style="color: var(--${amountClass}); font-weight: 600;">
                                    ${amountText}
                                </div>
                            `;
                            break;
                            
                        default:
                            description = transaction.type === 'deposit' ? 'Deposit' : 'Withdrawal';
                            amountText = `${transaction.type === 'deposit' ? '+' : '-'}$${transaction.amount.toFixed(2)}`;
                            amountClass = transaction.type === 'deposit' ? 'success-color' : 'error-color';
                            
                            item.innerHTML = `
                                <div>
                                    <div>${description}</div>
                                    <div style="font-size: 12px; color: #777;">${new Date(transaction.timestamp).toLocaleDateString()}</div>
                                </div>
                                <div style="color: var(--${amountClass}); font-weight: 600;">
                                    ${amountText}
                                </div>
                            `;
                    }
                    
                    // Make history item clickable
item.onclick = () => {
    showTransactionDetails(transaction);
};
listContainer.appendChild(item);
                });
            });
        } else {
            listContainer.innerHTML = '<p class="text-center">No transactions found.</p>';
        }
    });
}



        
        // --- Support ---
        function loadFAQs() {
            const faqContainer = document.getElementById('faq-list');
            faqContainer.innerHTML = '';
            
            database.ref('faqs').orderByChild('order').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    faqContainer.innerHTML = '<p class="text-center">No FAQs available at the moment.</p>';
                    return;
                }
                
                snapshot.forEach(child => {
                    const faq = child.val();
                    const faqItem = document.createElement('div');
                    faqItem.className = 'info-item';
                    faqItem.innerHTML = `
                        <div style="font-weight: 600;">${faq.question}</div>
                        <div style="color: #555; margin-top: 5px;">${faq.answer}</div>
                    `;
                    faqContainer.appendChild(faqItem);
                });
            });
        }
        
        function contactSupport(method) {
            let message = '';
            switch(method) {
                case 'whatsapp':
                    window.open('https://wa.me/1234567890', '_blank');
                    break;
                case 'telegram':
                    window.open('https://t.me/SafeInvestSupport', '_blank');
                    break;
                case 'email':
                    window.location.href = 'mailto:support@safinvestmax.com';
                    break;
            }
        }
        
        // --- Password Update ---
        function updatePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPopup('Error', 'Please fill in all password fields.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPopup('Error', 'New passwords do not match.');
                return;
            }
            
            if (newPassword.length < 6) {
                showPopup('Error', 'New password must be at least 6 characters long.');
                return;
            }
            
            // Reauthenticate user
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                currentPassword
            );
            
            currentUser.reauthenticateWithCredential(credential)
            .then(() => {
                // Update password
                return currentUser.updatePassword(newPassword);
            })
            .then(() => {
                showPopup('Success', 'Password updated successfully.');
                cancelPasswordUpdate();
            })
            .catch(error => {
                let message = 'Failed to update password.';
                if (error.code === 'auth/wrong-password') {
                    message = 'Current password is incorrect.';
                }
                showPopup('Error', message);
            });
        }
        
        function showSavingsAmountInput(planKey, minAmount, maxAmount) {
    document.getElementById(`amount-input-${planKey}`).style.display = 'block';
}

function hideSavingsAmountInput(planKey) {
    document.getElementById(`amount-input-${planKey}`).style.display = 'none';
    document.getElementById(`savings-amount-${planKey}`).value = '';
}
  
        function cancelPasswordUpdate() {
            document.getElementById('password-update-form').style.display = 'none';
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
        }

        // --- Helper Functions ---
        function showPopup(title, message) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message;
            document.getElementById('popup-buttons').innerHTML = `<button class="btn btn-primary" onclick="closePopup()">OK</button>`;
            document.getElementById('popup-overlay').style.display = 'flex';
        }

        function showConfirmationPopup(title, message, onConfirm, confirmText = 'Confirm') {
    document.getElementById('popup-title').innerHTML = title;
    document.getElementById('popup-message').innerHTML = message;
    
    const buttons = document.getElementById('popup-buttons');
    buttons.innerHTML = `
        <button class="btn btn-secondary" onclick="closePopup()">Cancel</button>
        <button class="btn btn-primary" id="popup-confirm-btn">${confirmText}</button>
    `;
    
    document.getElementById('popup-confirm-btn').onclick = () => {
        onConfirm();
        closePopup();
    };
    document.getElementById('popup-overlay').style.display = 'flex';
}

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
        }
        
        function closeTransactionDetails() {
    document.getElementById('transaction-details-popup').style.display = 'none';
    currentTransactionDetails = null;
}
        
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        // --- Empty functions that are now implemented ---
        function showCreateGiftCard() { 
            document.getElementById('create-gift-card').style.display = 'block'; 
            document.getElementById('redeem-gift-card').style.display = 'none';
        }
        
        function cancelCreateGiftCard() { 
            document.getElementById('create-gift-card').style.display = 'none'; 
        }
        
        function showRedeemGiftCard() { 
            document.getElementById('redeem-gift-card').style.display = 'block'; 
            document.getElementById('create-gift-card').style.display = 'none';
        }
        
        function cancelRedeemGiftCard() { 
            document.getElementById('redeem-gift-card').style.display = 'none'; 
        }

</script>
</body>
</html>
